"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * @module moduleGetSSLStatusLoopWorker
 */
var moduleGetSSLStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status.
   * @type {number}
   */
  timeOut: 10000,

  /**
   * The id of the timer function for status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * The event type used for the system event-bus (PBX >= 2024.2.30).
   */
  eventBusType: 'module-getssl-progress',

  /**
   * The identifier for the legacy PUB/SUB channel (PBX < 2024.2.30).
   */
  channelId: 'module-get-ssl-pub',

  /**
   * jQuery selector for the result message element.
   *
   * This property stores a reference to the DOM element with the ID 'div-result' using jQuery.
   */
  $resultBlock: $('#div-result'),

  /**
   * Initializes the moduleGetSSLStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    moduleGetSSLStatusLoopWorker.initializeAce();
    moduleGetSSLStatusLoopWorker.loadLastLog();

    if (moduleGetSSLStatusLoopWorker.versionCompare(globalPBXVersion, '2024.2.30') > 0) {
      moduleGetSSLStatusLoopWorker.startListenPushNotifications();
    } else {
      moduleGetSSLStatusLoopWorker.restartWorker();
    }
  },

  /**
   * Loads the last log file content into the ACE editor on page load.
   */
  loadLastLog: function loadLastLog() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModuleGetSsl/check-result"),
      on: 'now',
      method: 'GET',
      successTest: PbxApi.successTest,
      onSuccess: function onSuccess(response) {
        if (response.data.result && response.data.result.length > 0) {
          moduleGetSSLStatusLoopWorker.$resultBlock.show();
          moduleGetSSLStatusLoopWorker.editor.getSession().setValue(response.data.result);
        }
      },
      onFailure: function onFailure() {// Silently ignore - no log to show
      }
    });
  },

  /**
   * Restarts the moduleGetSSLStatus worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(moduleGetSSLStatusLoopWorker.timeoutHandle);
    moduleGetSSLStatusLoopWorker.worker();
  },

  /**
   * Worker function for fetching status.
   */
  worker: function worker() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModuleGetSsl/check-result"),
      on: 'now',
      method: 'GET',
      successTest: PbxApi.successTest,

      /**
       * Handles the successful response of the 'check-result' API request.
       * @param {object} response - The response object.
       */
      onSuccess: function onSuccess(response) {
        if (response.data.result.length > 0) {
          moduleGetSSLStatusLoopWorker.$resultBlock.show();
          moduleGetSSLStatusLoopWorker.editor.getSession().setValue(response.data.result);
        }

        moduleGetSSLStatusLoopWorker.timeoutHandle = window.setTimeout(moduleGetSSLStatusLoopWorker.worker, moduleGetSSLStatusLoopWorker.timeOut);
      },

      /**
       * Handles the failure response of the 'get-available-ldap-users' API request.
       * @param {object} response - The response object.
       */
      onFailure: function onFailure(response) {
        UserMessage.showMultiString(response.message);
        moduleGetSSLStatusLoopWorker.$resultBlock.hide();
      }
    });
  },

  /**
   * Initializes the Ace editor instance.
   * Sets up Ace editor with a monokai theme and custom options.
   * Attaches change handler to the editor session.
   */
  initializeAce: function initializeAce() {
    var aceHeight = window.innerHeight - 480;
    var rowsCount = Math.round(aceHeight / 16.3);
    $(window).load(function () {
      $('.application-code').css('min-height', "".concat(aceHeight, "px"));
    });
    moduleGetSSLStatusLoopWorker.editor = ace.edit('user-edit-config');

    var NewMode = ace.require('ace/mode/julia').Mode;

    moduleGetSSLStatusLoopWorker.editor.session.setMode(new NewMode());
    moduleGetSSLStatusLoopWorker.editor.setTheme('ace/theme/monokai');
    moduleGetSSLStatusLoopWorker.editor.resize();
    moduleGetSSLStatusLoopWorker.editor.getSession().on('change', function () {
      // Trigger change event to acknowledge the modification
      Form.dataChanged();
    });
    moduleGetSSLStatusLoopWorker.editor.setOptions({
      maxLines: rowsCount,
      showPrintMargin: false,
      showLineNumbers: false
    });
  },

  /**
   * Subscribes to system event-bus for real-time certificate progress updates (PBX >= 2024.2.30).
   * Falls back to polling if EventBus is not available.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    if (typeof EventBus === 'undefined') {
      moduleGetSSLStatusLoopWorker.restartWorker();
      return;
    }

    EventBus.subscribe(moduleGetSSLStatusLoopWorker.eventBusType, function (data) {
      console.debug(data);
      moduleGetSSLStatusLoopWorker.processStatusMessage(data);
    });
  },

  /**
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processStatusMessage: function processStatusMessage(response) {
    if (response.stageDetails.result) {
      moduleGetSSLStatusLoopWorker.$resultBlock.show();
      var resultText = moduleGetSSLStatusLoopWorker.editor.getSession().getValue();

      if (response.stage === 'STAGE_1_GENERATE_CONFIG') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_2_REQUEST_CERT') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_3_PARSE_RESPONSE' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_4_FINAL_RESULT' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      }

      moduleGetSSLStatusLoopWorker.editor.getSession().setValue(resultText);
    } else {
      UserMessage.showMultiString(response.stageDetails.messages);
      moduleGetSSLStatusLoopWorker.$resultBlock.hide();
    }
  },

  /**
   * Compare versions of modules.
   * @param {string} v1 - The first version to compare.
   * @param {string} v2 - The second version to compare.
   * @param {object} [options] - Optional configuration options.
   * @param {boolean} [options.lexicographical] - Whether to perform lexicographical comparison (default: false).
   * @param {boolean} [options.zeroExtend] - Weather to zero-extend the shorter version (default: false).
   * @returns {number} - A number indicating the comparison result: 0 if versions are equal, 1 if v1 is greater, -1 if v2 is greater, or NaN if the versions are invalid.
   */
  versionCompare: function versionCompare(v1, v2, options) {
    var lexicographical = options && options.lexicographical;
    var zeroExtend = options && options.zeroExtend;
    var v1parts = String(v1).split('.');
    var v2parts = String(v2).split('.');

    function isValidPart(x) {
      return (lexicographical ? /^\d+[A-Za-z]*$/ : /^\d+$/).test(x);
    }

    if (!v1parts.every(isValidPart) || !v2parts.every(isValidPart)) {
      return NaN;
    }

    if (zeroExtend) {
      while (v1parts.length < v2parts.length) {
        v1parts.push('0');
      }

      while (v2parts.length < v1parts.length) {
        v2parts.push('0');
      }
    }

    if (!lexicographical) {
      v1parts = v1parts.map(Number);
      v2parts = v2parts.map(Number);
    }

    for (var i = 0; i < v1parts.length; i += 1) {
      if (v2parts.length === i) {
        return 1;
      }

      if (v1parts[i] === v2parts[i]) {//
      } else if (v1parts[i] > v2parts[i]) {
        return 1;
      } else {
        return -1;
      }
    }

    if (v1parts.length !== v2parts.length) {
      return -1;
    }

    return 0;
  }
}; // Initializes the moduleGetSSLStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  moduleGetSSLStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtZ2V0LXNzbC1zdGF0dXMtd29ya2VyLmpzIl0sIm5hbWVzIjpbIm1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImV2ZW50QnVzVHlwZSIsImNoYW5uZWxJZCIsIiRyZXN1bHRCbG9jayIsIiQiLCJpbml0aWFsaXplIiwiaW5pdGlhbGl6ZUFjZSIsImxvYWRMYXN0TG9nIiwidmVyc2lvbkNvbXBhcmUiLCJnbG9iYWxQQlhWZXJzaW9uIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsInJlc3RhcnRXb3JrZXIiLCJhcGkiLCJ1cmwiLCJDb25maWciLCJwYnhVcmwiLCJvbiIsIm1ldGhvZCIsInN1Y2Nlc3NUZXN0IiwiUGJ4QXBpIiwib25TdWNjZXNzIiwicmVzcG9uc2UiLCJkYXRhIiwicmVzdWx0IiwibGVuZ3RoIiwic2hvdyIsImVkaXRvciIsImdldFNlc3Npb24iLCJzZXRWYWx1ZSIsIm9uRmFpbHVyZSIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJzZXRUaW1lb3V0IiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJtZXNzYWdlIiwiaGlkZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0Iiwicm93c0NvdW50IiwiTWF0aCIsInJvdW5kIiwibG9hZCIsImNzcyIsImFjZSIsImVkaXQiLCJOZXdNb2RlIiwicmVxdWlyZSIsIk1vZGUiLCJzZXNzaW9uIiwic2V0TW9kZSIsInNldFRoZW1lIiwicmVzaXplIiwiRm9ybSIsImRhdGFDaGFuZ2VkIiwic2V0T3B0aW9ucyIsIm1heExpbmVzIiwic2hvd1ByaW50TWFyZ2luIiwic2hvd0xpbmVOdW1iZXJzIiwiRXZlbnRCdXMiLCJzdWJzY3JpYmUiLCJjb25zb2xlIiwiZGVidWciLCJwcm9jZXNzU3RhdHVzTWVzc2FnZSIsInN0YWdlRGV0YWlscyIsInJlc3VsdFRleHQiLCJnZXRWYWx1ZSIsInN0YWdlIiwibWVzc2FnZXMiLCJ2MSIsInYyIiwib3B0aW9ucyIsImxleGljb2dyYXBoaWNhbCIsInplcm9FeHRlbmQiLCJ2MXBhcnRzIiwiU3RyaW5nIiwic3BsaXQiLCJ2MnBhcnRzIiwiaXNWYWxpZFBhcnQiLCJ4IiwidGVzdCIsImV2ZXJ5IiwiTmFOIiwicHVzaCIsIm1hcCIsIk51bWJlciIsImkiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsNEJBQTRCLEdBQUc7QUFFakM7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsT0FBTyxFQUFFLEtBTndCOztBQVFqQztBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUUsQ0Faa0I7O0FBZWpDO0FBQ0o7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUUsd0JBbEJtQjs7QUFvQmpDO0FBQ0o7QUFDQTtBQUNJQyxFQUFBQSxTQUFTLEVBQUUsb0JBdkJzQjs7QUF5QmpDO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsWUFBWSxFQUFFQyxDQUFDLENBQUMsYUFBRCxDQTlCa0I7O0FBZ0NqQztBQUNKO0FBQ0E7QUFDSUMsRUFBQUEsVUFuQ2lDLHdCQW1DckI7QUFDUlAsSUFBQUEsNEJBQTRCLENBQUNRLGFBQTdCO0FBQ0FSLElBQUFBLDRCQUE0QixDQUFDUyxXQUE3Qjs7QUFDQSxRQUFJVCw0QkFBNEIsQ0FBQ1UsY0FBN0IsQ0FBNENDLGdCQUE1QyxFQUE2RCxXQUE3RCxJQUEwRSxDQUE5RSxFQUFnRjtBQUM1RVgsTUFBQUEsNEJBQTRCLENBQUNZLDRCQUE3QjtBQUNILEtBRkQsTUFFTztBQUNIWixNQUFBQSw0QkFBNEIsQ0FBQ2EsYUFBN0I7QUFDSDtBQUNKLEdBM0NnQzs7QUE2Q2pDO0FBQ0o7QUFDQTtBQUNJSixFQUFBQSxXQWhEaUMseUJBZ0RuQjtBQUNWSCxJQUFBQSxDQUFDLENBQUNRLEdBQUYsQ0FBTTtBQUNGQyxNQUFBQSxHQUFHLFlBQUtDLE1BQU0sQ0FBQ0MsTUFBWixtREFERDtBQUVGQyxNQUFBQSxFQUFFLEVBQUUsS0FGRjtBQUdGQyxNQUFBQSxNQUFNLEVBQUUsS0FITjtBQUlGQyxNQUFBQSxXQUFXLEVBQUVDLE1BQU0sQ0FBQ0QsV0FKbEI7QUFLRkUsTUFBQUEsU0FBUyxFQUFFLG1CQUFVQyxRQUFWLEVBQW9CO0FBQzNCLFlBQUlBLFFBQVEsQ0FBQ0MsSUFBVCxDQUFjQyxNQUFkLElBQXdCRixRQUFRLENBQUNDLElBQVQsQ0FBY0MsTUFBZCxDQUFxQkMsTUFBckIsR0FBOEIsQ0FBMUQsRUFBNkQ7QUFDekQxQixVQUFBQSw0QkFBNEIsQ0FBQ0ssWUFBN0IsQ0FBMENzQixJQUExQztBQUNBM0IsVUFBQUEsNEJBQTRCLENBQUM0QixNQUE3QixDQUFvQ0MsVUFBcEMsR0FBaURDLFFBQWpELENBQTBEUCxRQUFRLENBQUNDLElBQVQsQ0FBY0MsTUFBeEU7QUFDSDtBQUNKLE9BVkM7QUFXRk0sTUFBQUEsU0FBUyxFQUFFLHFCQUFXLENBQ2xCO0FBQ0g7QUFiQyxLQUFOO0FBZUgsR0FoRWdDOztBQWtFakM7QUFDSjtBQUNBO0FBQ0lsQixFQUFBQSxhQXJFaUMsMkJBcUVqQjtBQUNabUIsSUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CakMsNEJBQTRCLENBQUNrQyxhQUFqRDtBQUNBbEMsSUFBQUEsNEJBQTRCLENBQUNtQyxNQUE3QjtBQUNILEdBeEVnQzs7QUEwRWpDO0FBQ0o7QUFDQTtBQUNJQSxFQUFBQSxNQTdFaUMsb0JBNkV4QjtBQUNMN0IsSUFBQUEsQ0FBQyxDQUFDUSxHQUFGLENBQU07QUFDRkMsTUFBQUEsR0FBRyxZQUFLQyxNQUFNLENBQUNDLE1BQVosbURBREQ7QUFFRkMsTUFBQUEsRUFBRSxFQUFFLEtBRkY7QUFHRkMsTUFBQUEsTUFBTSxFQUFFLEtBSE47QUFJRkMsTUFBQUEsV0FBVyxFQUFFQyxNQUFNLENBQUNELFdBSmxCOztBQUtGO0FBQ1o7QUFDQTtBQUNBO0FBQ1lFLE1BQUFBLFNBQVMsRUFBRSxtQkFBVUMsUUFBVixFQUFvQjtBQUMzQixZQUFJQSxRQUFRLENBQUNDLElBQVQsQ0FBY0MsTUFBZCxDQUFxQkMsTUFBckIsR0FBOEIsQ0FBbEMsRUFBcUM7QUFDakMxQixVQUFBQSw0QkFBNEIsQ0FBQ0ssWUFBN0IsQ0FBMENzQixJQUExQztBQUNBM0IsVUFBQUEsNEJBQTRCLENBQUM0QixNQUE3QixDQUFvQ0MsVUFBcEMsR0FBaURDLFFBQWpELENBQTBEUCxRQUFRLENBQUNDLElBQVQsQ0FBY0MsTUFBeEU7QUFDSDs7QUFDRHpCLFFBQUFBLDRCQUE0QixDQUFDa0MsYUFBN0IsR0FBNkNGLE1BQU0sQ0FBQ0ksVUFBUCxDQUN6Q3BDLDRCQUE0QixDQUFDbUMsTUFEWSxFQUV6Q25DLDRCQUE0QixDQUFDQyxPQUZZLENBQTdDO0FBSUgsT0FsQkM7O0FBbUJGO0FBQ1o7QUFDQTtBQUNBO0FBQ1k4QixNQUFBQSxTQUFTLEVBQUUsbUJBQVNSLFFBQVQsRUFBbUI7QUFDMUJjLFFBQUFBLFdBQVcsQ0FBQ0MsZUFBWixDQUE0QmYsUUFBUSxDQUFDZ0IsT0FBckM7QUFDQXZDLFFBQUFBLDRCQUE0QixDQUFDSyxZQUE3QixDQUEwQ21DLElBQTFDO0FBQ0g7QUExQkMsS0FBTjtBQTRCSCxHQTFHZ0M7O0FBNEdqQztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0loQyxFQUFBQSxhQWpIaUMsMkJBaUhqQjtBQUNaLFFBQU1pQyxTQUFTLEdBQUdULE1BQU0sQ0FBQ1UsV0FBUCxHQUFxQixHQUF2QztBQUNBLFFBQU1DLFNBQVMsR0FBR0MsSUFBSSxDQUFDQyxLQUFMLENBQVdKLFNBQVMsR0FBRyxJQUF2QixDQUFsQjtBQUNBbkMsSUFBQUEsQ0FBQyxDQUFDMEIsTUFBRCxDQUFELENBQVVjLElBQVYsQ0FBZSxZQUFZO0FBQ3ZCeEMsTUFBQUEsQ0FBQyxDQUFDLG1CQUFELENBQUQsQ0FBdUJ5QyxHQUF2QixDQUEyQixZQUEzQixZQUE0Q04sU0FBNUM7QUFDSCxLQUZEO0FBR0F6QyxJQUFBQSw0QkFBNEIsQ0FBQzRCLE1BQTdCLEdBQXNDb0IsR0FBRyxDQUFDQyxJQUFKLENBQVMsa0JBQVQsQ0FBdEM7O0FBQ0EsUUFBSUMsT0FBTyxHQUFHRixHQUFHLENBQUNHLE9BQUosQ0FBWSxnQkFBWixFQUE4QkMsSUFBNUM7O0FBQ0FwRCxJQUFBQSw0QkFBNEIsQ0FBQzRCLE1BQTdCLENBQW9DeUIsT0FBcEMsQ0FBNENDLE9BQTVDLENBQW9ELElBQUlKLE9BQUosRUFBcEQ7QUFDQWxELElBQUFBLDRCQUE0QixDQUFDNEIsTUFBN0IsQ0FBb0MyQixRQUFwQyxDQUE2QyxtQkFBN0M7QUFDQXZELElBQUFBLDRCQUE0QixDQUFDNEIsTUFBN0IsQ0FBb0M0QixNQUFwQztBQUNBeEQsSUFBQUEsNEJBQTRCLENBQUM0QixNQUE3QixDQUFvQ0MsVUFBcEMsR0FBaURYLEVBQWpELENBQW9ELFFBQXBELEVBQThELFlBQU07QUFDaEU7QUFDQXVDLE1BQUFBLElBQUksQ0FBQ0MsV0FBTDtBQUNILEtBSEQ7QUFLQTFELElBQUFBLDRCQUE0QixDQUFDNEIsTUFBN0IsQ0FBb0MrQixVQUFwQyxDQUErQztBQUMzQ0MsTUFBQUEsUUFBUSxFQUFFakIsU0FEaUM7QUFFM0NrQixNQUFBQSxlQUFlLEVBQUUsS0FGMEI7QUFHM0NDLE1BQUFBLGVBQWUsRUFBRTtBQUgwQixLQUEvQztBQUtILEdBdElnQzs7QUF1SWpDO0FBQ0o7QUFDQTtBQUNBO0FBQ0lsRCxFQUFBQSw0QkEzSWlDLDBDQTJJRjtBQUMzQixRQUFJLE9BQU9tRCxRQUFQLEtBQW9CLFdBQXhCLEVBQXFDO0FBQ2pDL0QsTUFBQUEsNEJBQTRCLENBQUNhLGFBQTdCO0FBQ0E7QUFDSDs7QUFDRGtELElBQUFBLFFBQVEsQ0FBQ0MsU0FBVCxDQUFtQmhFLDRCQUE0QixDQUFDRyxZQUFoRCxFQUE4RCxVQUFDcUIsSUFBRCxFQUFVO0FBQ3BFeUMsTUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWMxQyxJQUFkO0FBQ0F4QixNQUFBQSw0QkFBNEIsQ0FBQ21FLG9CQUE3QixDQUFrRDNDLElBQWxEO0FBQ0gsS0FIRDtBQUlILEdBcEpnQzs7QUFzSmpDO0FBQ0o7QUFDQTtBQUNBO0FBQ0kyQyxFQUFBQSxvQkExSmlDLGdDQTBKWjVDLFFBMUpZLEVBMEpIO0FBQzFCLFFBQUlBLFFBQVEsQ0FBQzZDLFlBQVQsQ0FBc0IzQyxNQUExQixFQUFpQztBQUM3QnpCLE1BQUFBLDRCQUE0QixDQUFDSyxZQUE3QixDQUEwQ3NCLElBQTFDO0FBQ0EsVUFBSTBDLFVBQVUsR0FBR3JFLDRCQUE0QixDQUFDNEIsTUFBN0IsQ0FBb0NDLFVBQXBDLEdBQWlEeUMsUUFBakQsRUFBakI7O0FBQ0EsVUFBSS9DLFFBQVEsQ0FBQ2dELEtBQVQsS0FBbUIseUJBQXZCLEVBQWlEO0FBQzdDRixRQUFBQSxVQUFVLElBQUksT0FBTzlDLFFBQVEsQ0FBQzZDLFlBQVQsQ0FBc0I1QyxJQUF0QixDQUEyQkMsTUFBaEQ7QUFDSCxPQUZELE1BRU8sSUFBR0YsUUFBUSxDQUFDZ0QsS0FBVCxLQUFtQixzQkFBdEIsRUFBOEM7QUFDakRGLFFBQUFBLFVBQVUsSUFBSSxPQUFPOUMsUUFBUSxDQUFDNkMsWUFBVCxDQUFzQjVDLElBQXRCLENBQTJCQyxNQUFoRDtBQUNILE9BRk0sTUFFQSxJQUFHRixRQUFRLENBQUNnRCxLQUFULEtBQW1CLHdCQUFuQixJQUErQ2hELFFBQVEsQ0FBQzZDLFlBQVQsQ0FBc0I1QyxJQUF0QixDQUEyQkMsTUFBM0IsQ0FBa0NDLE1BQWxDLEdBQTJDLENBQTdGLEVBQWdHO0FBQ25HMkMsUUFBQUEsVUFBVSxHQUFHOUMsUUFBUSxDQUFDNkMsWUFBVCxDQUFzQjVDLElBQXRCLENBQTJCQyxNQUF4QztBQUNILE9BRk0sTUFFQSxJQUFHRixRQUFRLENBQUNnRCxLQUFULEtBQW1CLHNCQUFuQixJQUE2Q2hELFFBQVEsQ0FBQzZDLFlBQVQsQ0FBc0I1QyxJQUF0QixDQUEyQkMsTUFBM0IsQ0FBa0NDLE1BQWxDLEdBQTJDLENBQTNGLEVBQStGO0FBQ2xHMkMsUUFBQUEsVUFBVSxHQUFHOUMsUUFBUSxDQUFDNkMsWUFBVCxDQUFzQjVDLElBQXRCLENBQTJCQyxNQUF4QztBQUNIOztBQUNEekIsTUFBQUEsNEJBQTRCLENBQUM0QixNQUE3QixDQUFvQ0MsVUFBcEMsR0FBaURDLFFBQWpELENBQTBEdUMsVUFBMUQ7QUFDSCxLQWJELE1BYU87QUFDSGhDLE1BQUFBLFdBQVcsQ0FBQ0MsZUFBWixDQUE0QmYsUUFBUSxDQUFDNkMsWUFBVCxDQUFzQkksUUFBbEQ7QUFDQXhFLE1BQUFBLDRCQUE0QixDQUFDSyxZQUE3QixDQUEwQ21DLElBQTFDO0FBQ0g7QUFDSixHQTVLZ0M7O0FBOEtqQztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDSTlCLEVBQUFBLGNBdkxpQywwQkF1TGxCK0QsRUF2TGtCLEVBdUxkQyxFQXZMYyxFQXVMVkMsT0F2TFUsRUF1TEQ7QUFDNUIsUUFBTUMsZUFBZSxHQUFHRCxPQUFPLElBQUlBLE9BQU8sQ0FBQ0MsZUFBM0M7QUFDQSxRQUFNQyxVQUFVLEdBQUdGLE9BQU8sSUFBSUEsT0FBTyxDQUFDRSxVQUF0QztBQUNBLFFBQUlDLE9BQU8sR0FBR0MsTUFBTSxDQUFDTixFQUFELENBQU4sQ0FBV08sS0FBWCxDQUFpQixHQUFqQixDQUFkO0FBQ0EsUUFBSUMsT0FBTyxHQUFHRixNQUFNLENBQUNMLEVBQUQsQ0FBTixDQUFXTSxLQUFYLENBQWlCLEdBQWpCLENBQWQ7O0FBRUEsYUFBU0UsV0FBVCxDQUFxQkMsQ0FBckIsRUFBd0I7QUFDcEIsYUFBTyxDQUFDUCxlQUFlLEdBQUcsZ0JBQUgsR0FBc0IsT0FBdEMsRUFBK0NRLElBQS9DLENBQW9ERCxDQUFwRCxDQUFQO0FBQ0g7O0FBRUQsUUFBSSxDQUFDTCxPQUFPLENBQUNPLEtBQVIsQ0FBY0gsV0FBZCxDQUFELElBQStCLENBQUNELE9BQU8sQ0FBQ0ksS0FBUixDQUFjSCxXQUFkLENBQXBDLEVBQWdFO0FBQzVELGFBQU9JLEdBQVA7QUFDSDs7QUFFRCxRQUFJVCxVQUFKLEVBQWdCO0FBQ1osYUFBT0MsT0FBTyxDQUFDcEQsTUFBUixHQUFpQnVELE9BQU8sQ0FBQ3ZELE1BQWhDO0FBQXdDb0QsUUFBQUEsT0FBTyxDQUFDUyxJQUFSLENBQWEsR0FBYjtBQUF4Qzs7QUFDQSxhQUFPTixPQUFPLENBQUN2RCxNQUFSLEdBQWlCb0QsT0FBTyxDQUFDcEQsTUFBaEM7QUFBd0N1RCxRQUFBQSxPQUFPLENBQUNNLElBQVIsQ0FBYSxHQUFiO0FBQXhDO0FBQ0g7O0FBRUQsUUFBSSxDQUFDWCxlQUFMLEVBQXNCO0FBQ2xCRSxNQUFBQSxPQUFPLEdBQUdBLE9BQU8sQ0FBQ1UsR0FBUixDQUFZQyxNQUFaLENBQVY7QUFDQVIsTUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNPLEdBQVIsQ0FBWUMsTUFBWixDQUFWO0FBQ0g7O0FBRUQsU0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHWixPQUFPLENBQUNwRCxNQUE1QixFQUFvQ2dFLENBQUMsSUFBSSxDQUF6QyxFQUE0QztBQUN4QyxVQUFJVCxPQUFPLENBQUN2RCxNQUFSLEtBQW1CZ0UsQ0FBdkIsRUFBMEI7QUFDdEIsZUFBTyxDQUFQO0FBQ0g7O0FBQ0QsVUFBSVosT0FBTyxDQUFDWSxDQUFELENBQVAsS0FBZVQsT0FBTyxDQUFDUyxDQUFELENBQTFCLEVBQStCLENBQzNCO0FBQ0gsT0FGRCxNQUVPLElBQUlaLE9BQU8sQ0FBQ1ksQ0FBRCxDQUFQLEdBQWFULE9BQU8sQ0FBQ1MsQ0FBRCxDQUF4QixFQUE2QjtBQUNoQyxlQUFPLENBQVA7QUFDSCxPQUZNLE1BRUE7QUFDSCxlQUFPLENBQUMsQ0FBUjtBQUNIO0FBQ0o7O0FBRUQsUUFBSVosT0FBTyxDQUFDcEQsTUFBUixLQUFtQnVELE9BQU8sQ0FBQ3ZELE1BQS9CLEVBQXVDO0FBQ25DLGFBQU8sQ0FBQyxDQUFSO0FBQ0g7O0FBRUQsV0FBTyxDQUFQO0FBQ0g7QUFqT2dDLENBQXJDLEMsQ0FxT0E7O0FBQ0FwQixDQUFDLENBQUNxRixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCNUYsRUFBQUEsNEJBQTRCLENBQUNPLFVBQTdCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UgKi9cblxuLyoqXG4gKiBAbW9kdWxlIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogMTAwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciBzdGF0dXMgd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuXG4gICAgLyoqXG4gICAgICogVGhlIGV2ZW50IHR5cGUgdXNlZCBmb3IgdGhlIHN5c3RlbSBldmVudC1idXMgKFBCWCA+PSAyMDI0LjIuMzApLlxuICAgICAqL1xuICAgIGV2ZW50QnVzVHlwZTogJ21vZHVsZS1nZXRzc2wtcHJvZ3Jlc3MnLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkZW50aWZpZXIgZm9yIHRoZSBsZWdhY3kgUFVCL1NVQiBjaGFubmVsIChQQlggPCAyMDI0LjIuMzApLlxuICAgICAqL1xuICAgIGNoYW5uZWxJZDogJ21vZHVsZS1nZXQtc3NsLXB1YicsXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgc2VsZWN0b3IgZm9yIHRoZSByZXN1bHQgbWVzc2FnZSBlbGVtZW50LlxuICAgICAqXG4gICAgICogVGhpcyBwcm9wZXJ0eSBzdG9yZXMgYSByZWZlcmVuY2UgdG8gdGhlIERPTSBlbGVtZW50IHdpdGggdGhlIElEICdkaXYtcmVzdWx0JyB1c2luZyBqUXVlcnkuXG4gICAgICovXG4gICAgJHJlc3VsdEJsb2NrOiAkKCcjZGl2LXJlc3VsdCcpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIgbW9kdWxlIGJ5IHNldHRpbmcgdXAgdGhlIGNvbm5lY3Rpb24gdG8gcmVjZWl2ZSBzZXJ2ZXItc2VudCBldmVudHMuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpe1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemVBY2UoKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5sb2FkTGFzdExvZygpO1xuICAgICAgICBpZiAobW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci52ZXJzaW9uQ29tcGFyZShnbG9iYWxQQlhWZXJzaW9uLCcyMDI0LjIuMzAnKT4wKXtcbiAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuc3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogTG9hZHMgdGhlIGxhc3QgbG9nIGZpbGUgY29udGVudCBpbnRvIHRoZSBBQ0UgZWRpdG9yIG9uIHBhZ2UgbG9hZC5cbiAgICAgKi9cbiAgICBsb2FkTGFzdExvZygpIHtcbiAgICAgICAgJC5hcGkoe1xuICAgICAgICAgICAgdXJsOiBgJHtDb25maWcucGJ4VXJsfS9wYnhjb3JlL2FwaS9tb2R1bGVzL01vZHVsZUdldFNzbC9jaGVjay1yZXN1bHRgLFxuICAgICAgICAgICAgb246ICdub3cnLFxuICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgIHN1Y2Nlc3NUZXN0OiBQYnhBcGkuc3VjY2Vzc1Rlc3QsXG4gICAgICAgICAgICBvblN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3VsdCAmJiByZXNwb25zZS5kYXRhLnJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHJlc3BvbnNlLmRhdGEucmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25GYWlsdXJlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAvLyBTaWxlbnRseSBpZ25vcmUgLSBubyBsb2cgdG8gc2hvd1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzdGFydHMgdGhlIG1vZHVsZUdldFNTTFN0YXR1cyB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGZldGNoaW5nIHN0YXR1cy5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgIHVybDogYCR7Q29uZmlnLnBieFVybH0vcGJ4Y29yZS9hcGkvbW9kdWxlcy9Nb2R1bGVHZXRTc2wvY2hlY2stcmVzdWx0YCxcbiAgICAgICAgICAgIG9uOiAnbm93JyxcbiAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICBzdWNjZXNzVGVzdDogUGJ4QXBpLnN1Y2Nlc3NUZXN0LFxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBIYW5kbGVzIHRoZSBzdWNjZXNzZnVsIHJlc3BvbnNlIG9mIHRoZSAnY2hlY2stcmVzdWx0JyBBUEkgcmVxdWVzdC5cbiAgICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBvYmplY3QuXG4gICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIG9uU3VjY2VzczogZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEucmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci4kcmVzdWx0QmxvY2suc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUocmVzcG9uc2UuZGF0YS5yZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUgPSB3aW5kb3cuc2V0VGltZW91dChcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci53b3JrZXIsXG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIudGltZU91dCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogSGFuZGxlcyB0aGUgZmFpbHVyZSByZXNwb25zZSBvZiB0aGUgJ2dldC1hdmFpbGFibGUtbGRhcC11c2VycycgQVBJIHJlcXVlc3QuXG4gICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBvbkZhaWx1cmU6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLmhpZGUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBBY2UgZWRpdG9yIGluc3RhbmNlLlxuICAgICAqIFNldHMgdXAgQWNlIGVkaXRvciB3aXRoIGEgbW9ub2thaSB0aGVtZSBhbmQgY3VzdG9tIG9wdGlvbnMuXG4gICAgICogQXR0YWNoZXMgY2hhbmdlIGhhbmRsZXIgdG8gdGhlIGVkaXRvciBzZXNzaW9uLlxuICAgICAqL1xuICAgIGluaXRpYWxpemVBY2UoKSB7XG4gICAgICAgIGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDQ4MDtcbiAgICAgICAgY29uc3Qgcm93c0NvdW50ID0gTWF0aC5yb3VuZChhY2VIZWlnaHQgLyAxNi4zKTtcbiAgICAgICAgJCh3aW5kb3cpLmxvYWQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJCgnLmFwcGxpY2F0aW9uLWNvZGUnKS5jc3MoJ21pbi1oZWlnaHQnLCBgJHthY2VIZWlnaHR9cHhgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yID0gYWNlLmVkaXQoJ3VzZXItZWRpdC1jb25maWcnKTtcbiAgICAgICAgbGV0IE5ld01vZGUgPSBhY2UucmVxdWlyZSgnYWNlL21vZGUvanVsaWEnKS5Nb2RlO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5zZXNzaW9uLnNldE1vZGUobmV3IE5ld01vZGUoKSk7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLnNldFRoZW1lKCdhY2UvdGhlbWUvbW9ub2thaScpO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5yZXNpemUoKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCAoKSA9PiB7XG4gICAgICAgICAgICAvLyBUcmlnZ2VyIGNoYW5nZSBldmVudCB0byBhY2tub3dsZWRnZSB0aGUgbW9kaWZpY2F0aW9uXG4gICAgICAgICAgICBGb3JtLmRhdGFDaGFuZ2VkKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLnNldE9wdGlvbnMoe1xuICAgICAgICAgICAgbWF4TGluZXM6IHJvd3NDb3VudCxcbiAgICAgICAgICAgIHNob3dQcmludE1hcmdpbjogZmFsc2UsXG4gICAgICAgICAgICBzaG93TGluZU51bWJlcnM6IGZhbHNlLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIFN1YnNjcmliZXMgdG8gc3lzdGVtIGV2ZW50LWJ1cyBmb3IgcmVhbC10aW1lIGNlcnRpZmljYXRlIHByb2dyZXNzIHVwZGF0ZXMgKFBCWCA+PSAyMDI0LjIuMzApLlxuICAgICAqIEZhbGxzIGJhY2sgdG8gcG9sbGluZyBpZiBFdmVudEJ1cyBpcyBub3QgYXZhaWxhYmxlLlxuICAgICAqL1xuICAgIHN0YXJ0TGlzdGVuUHVzaE5vdGlmaWNhdGlvbnMoKSB7XG4gICAgICAgIGlmICh0eXBlb2YgRXZlbnRCdXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnJlc3RhcnRXb3JrZXIoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBFdmVudEJ1cy5zdWJzY3JpYmUobW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5ldmVudEJ1c1R5cGUsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKGRhdGEpO1xuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5wcm9jZXNzU3RhdHVzTWVzc2FnZShkYXRhKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIGRhdGEgcGF5bG9hZCBvZiB0aGUgc2VydmVyLXNlbnQgZXZlbnQsIGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dCB0aGUgaW5zdGFsbGF0aW9uIHN0YWdlIGFuZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBwcm9jZXNzU3RhdHVzTWVzc2FnZShyZXNwb25zZSl7XG4gICAgICAgIGlmIChyZXNwb25zZS5zdGFnZURldGFpbHMucmVzdWx0KXtcbiAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLnNob3coKTtcbiAgICAgICAgICAgIGxldCByZXN1bHRUZXh0ID0gbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLmdldFZhbHVlKCk7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhZ2UgPT09ICdTVEFHRV8xX0dFTkVSQVRFX0NPTkZJRycpe1xuICAgICAgICAgICAgICAgIHJlc3VsdFRleHQgKz0gJ1xcbicgKyByZXNwb25zZS5zdGFnZURldGFpbHMuZGF0YS5yZXN1bHQ7XG4gICAgICAgICAgICB9IGVsc2UgaWYocmVzcG9uc2Uuc3RhZ2UgPT09ICdTVEFHRV8yX1JFUVVFU1RfQ0VSVCcpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ICs9ICdcXG4nICsgcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfM19QQVJTRV9SRVNQT05TRScgJiYgcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfNF9GSU5BTF9SRVNVTFQnICYmIHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdC5sZW5ndGggPiAwICkge1xuICAgICAgICAgICAgICAgIHJlc3VsdFRleHQgPSByZXNwb25zZS5zdGFnZURldGFpbHMuZGF0YS5yZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUocmVzdWx0VGV4dCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLm1lc3NhZ2VzKTtcbiAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLmhpZGUoKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDb21wYXJlIHZlcnNpb25zIG9mIG1vZHVsZXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHYxIC0gVGhlIGZpcnN0IHZlcnNpb24gdG8gY29tcGFyZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdjIgLSBUaGUgc2Vjb25kIHZlcnNpb24gdG8gY29tcGFyZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9uYWwgY29uZmlndXJhdGlvbiBvcHRpb25zLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMubGV4aWNvZ3JhcGhpY2FsXSAtIFdoZXRoZXIgdG8gcGVyZm9ybSBsZXhpY29ncmFwaGljYWwgY29tcGFyaXNvbiAoZGVmYXVsdDogZmFsc2UpLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuemVyb0V4dGVuZF0gLSBXZWF0aGVyIHRvIHplcm8tZXh0ZW5kIHRoZSBzaG9ydGVyIHZlcnNpb24gKGRlZmF1bHQ6IGZhbHNlKS5cbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSAtIEEgbnVtYmVyIGluZGljYXRpbmcgdGhlIGNvbXBhcmlzb24gcmVzdWx0OiAwIGlmIHZlcnNpb25zIGFyZSBlcXVhbCwgMSBpZiB2MSBpcyBncmVhdGVyLCAtMSBpZiB2MiBpcyBncmVhdGVyLCBvciBOYU4gaWYgdGhlIHZlcnNpb25zIGFyZSBpbnZhbGlkLlxuICAgICAqL1xuICAgIHZlcnNpb25Db21wYXJlKHYxLCB2Miwgb3B0aW9ucykge1xuICAgICAgICBjb25zdCBsZXhpY29ncmFwaGljYWwgPSBvcHRpb25zICYmIG9wdGlvbnMubGV4aWNvZ3JhcGhpY2FsO1xuICAgICAgICBjb25zdCB6ZXJvRXh0ZW5kID0gb3B0aW9ucyAmJiBvcHRpb25zLnplcm9FeHRlbmQ7XG4gICAgICAgIGxldCB2MXBhcnRzID0gU3RyaW5nKHYxKS5zcGxpdCgnLicpO1xuICAgICAgICBsZXQgdjJwYXJ0cyA9IFN0cmluZyh2Mikuc3BsaXQoJy4nKTtcblxuICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkUGFydCh4KSB7XG4gICAgICAgICAgICByZXR1cm4gKGxleGljb2dyYXBoaWNhbCA/IC9eXFxkK1tBLVphLXpdKiQvIDogL15cXGQrJC8pLnRlc3QoeCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXYxcGFydHMuZXZlcnkoaXNWYWxpZFBhcnQpIHx8ICF2MnBhcnRzLmV2ZXJ5KGlzVmFsaWRQYXJ0KSkge1xuICAgICAgICAgICAgcmV0dXJuIE5hTjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh6ZXJvRXh0ZW5kKSB7XG4gICAgICAgICAgICB3aGlsZSAodjFwYXJ0cy5sZW5ndGggPCB2MnBhcnRzLmxlbmd0aCkgdjFwYXJ0cy5wdXNoKCcwJyk7XG4gICAgICAgICAgICB3aGlsZSAodjJwYXJ0cy5sZW5ndGggPCB2MXBhcnRzLmxlbmd0aCkgdjJwYXJ0cy5wdXNoKCcwJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWxleGljb2dyYXBoaWNhbCkge1xuICAgICAgICAgICAgdjFwYXJ0cyA9IHYxcGFydHMubWFwKE51bWJlcik7XG4gICAgICAgICAgICB2MnBhcnRzID0gdjJwYXJ0cy5tYXAoTnVtYmVyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdjFwYXJ0cy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICAgICAgaWYgKHYycGFydHMubGVuZ3RoID09PSBpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodjFwYXJ0c1tpXSA9PT0gdjJwYXJ0c1tpXSkge1xuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHYxcGFydHNbaV0gPiB2MnBhcnRzW2ldKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2MXBhcnRzLmxlbmd0aCAhPT0gdjJwYXJ0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAwO1xuICAgIH0sXG5cbn07XG5cbi8vIEluaXRpYWxpemVzIHRoZSBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyIG1vZHVsZSB3aGVuIHRoZSBET00gaXMgZnVsbHkgbG9hZGVkLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7Il19