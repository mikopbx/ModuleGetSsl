"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * @module moduleGetSSLStatusLoopWorker
 */
var moduleGetSSLStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status.
   * @type {number}
   */
  timeOut: 10000,

  /**
   * The id of the timer function for status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to module status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'module-get-ssl-pub',

  /**
   * jQuery selector for the result message element.
   *
   * This property stores a reference to the DOM element with the ID 'div-result' using jQuery.
   */
  $resultBlock: $('#div-result'),

  /**
   * Initializes the moduleGetSSLStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    moduleGetSSLStatusLoopWorker.initializeAce();

    if (moduleGetSSLStatusLoopWorker.versionCompare(globalPBXVersion, '2024.2.30') > 0) {
      moduleGetSSLStatusLoopWorker.startListenPushNotifications();
    } else {
      moduleGetSSLStatusLoopWorker.restartWorker();
    }
  },

  /**
   * Restarts the moduleGetSSLStatus worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(moduleGetSSLStatusLoopWorker.timeoutHandle);
    moduleGetSSLStatusLoopWorker.worker();
  },

  /**
   * Worker function for fetching status.
   */
  worker: function worker() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModuleGetSsl/check-result"),
      on: 'now',
      method: 'GET',
      successTest: PbxApi.successTest,

      /**
       * Handles the successful response of the 'check-result' API request.
       * @param {object} response - The response object.
       */
      onSuccess: function onSuccess(response) {
        if (response.data.result.length > 0) {
          moduleGetSSLStatusLoopWorker.$resultBlock.show();
          moduleGetSSLStatusLoopWorker.editor.getSession().setValue(response.data.result);
        }

        moduleGetSSLStatusLoopWorker.timeoutHandle = window.setTimeout(moduleGetSSLStatusLoopWorker.worker, moduleGetSSLStatusLoopWorker.timeOut);
      },

      /**
       * Handles the failure response of the 'get-available-ldap-users' API request.
       * @param {object} response - The response object.
       */
      onFailure: function onFailure(response) {
        UserMessage.showMultiString(response.message);
        moduleGetSSLStatusLoopWorker.$resultBlock.hide();
      }
    });
  },

  /**
   * Initializes the Ace editor instance.
   * Sets up Ace editor with a monokai theme and custom options.
   * Attaches change handler to the editor session.
   */
  initializeAce: function initializeAce() {
    var aceHeight = window.innerHeight - 480;
    var rowsCount = Math.round(aceHeight / 16.3);
    $(window).load(function () {
      $('.application-code').css('min-height', "".concat(aceHeight, "px"));
    });
    moduleGetSSLStatusLoopWorker.editor = ace.edit('user-edit-config');

    var NewMode = ace.require('ace/mode/julia').Mode;

    moduleGetSSLStatusLoopWorker.editor.session.setMode(new NewMode());
    moduleGetSSLStatusLoopWorker.editor.setTheme('ace/theme/monokai');
    moduleGetSSLStatusLoopWorker.editor.resize();
    moduleGetSSLStatusLoopWorker.editor.getSession().on('change', function () {
      // Trigger change event to acknowledge the modification
      Form.dataChanged();
    });
    moduleGetSSLStatusLoopWorker.editor.setOptions({
      maxLines: rowsCount,
      showPrintMargin: false,
      showLineNumbers: false
    });
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "".concat(moduleGetSSLStatusLoopWorker.channelId, "-lastEventId");
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(moduleGetSSLStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(moduleGetSSLStatusLoopWorker.channelId);
    moduleGetSSLStatusLoopWorker.eventSource = new EventSource(subPath);
    moduleGetSSLStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      console.debug(response);
      moduleGetSSLStatusLoopWorker.processStatusMessage(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processStatusMessage: function processStatusMessage(response) {
    if (response.stageDetails.result) {
      moduleGetSSLStatusLoopWorker.$resultBlock.show();
      var resultText = moduleGetSSLStatusLoopWorker.editor.getSession().getValue();

      if (response.stage === 'STAGE_1_GENERATE_CONFIG') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_2_REQUEST_CERT') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_3_PARSE_RESPONSE' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_4_FINAL_RESULT' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      }

      moduleGetSSLStatusLoopWorker.editor.getSession().setValue(resultText);
    } else {
      UserMessage.showMultiString(response.stageDetails.messages);
      moduleGetSSLStatusLoopWorker.$resultBlock.hide();
    }
  },

  /**
   * Compare versions of modules.
   * @param {string} v1 - The first version to compare.
   * @param {string} v2 - The second version to compare.
   * @param {object} [options] - Optional configuration options.
   * @param {boolean} [options.lexicographical] - Whether to perform lexicographical comparison (default: false).
   * @param {boolean} [options.zeroExtend] - Weather to zero-extend the shorter version (default: false).
   * @returns {number} - A number indicating the comparison result: 0 if versions are equal, 1 if v1 is greater, -1 if v2 is greater, or NaN if the versions are invalid.
   */
  versionCompare: function versionCompare(v1, v2, options) {
    var lexicographical = options && options.lexicographical;
    var zeroExtend = options && options.zeroExtend;
    var v1parts = String(v1).split('.');
    var v2parts = String(v2).split('.');

    function isValidPart(x) {
      return (lexicographical ? /^\d+[A-Za-z]*$/ : /^\d+$/).test(x);
    }

    if (!v1parts.every(isValidPart) || !v2parts.every(isValidPart)) {
      return NaN;
    }

    if (zeroExtend) {
      while (v1parts.length < v2parts.length) {
        v1parts.push('0');
      }

      while (v2parts.length < v1parts.length) {
        v2parts.push('0');
      }
    }

    if (!lexicographical) {
      v1parts = v1parts.map(Number);
      v2parts = v2parts.map(Number);
    }

    for (var i = 0; i < v1parts.length; i += 1) {
      if (v2parts.length === i) {
        return 1;
      }

      if (v1parts[i] === v2parts[i]) {//
      } else if (v1parts[i] > v2parts[i]) {
        return 1;
      } else {
        return -1;
      }
    }

    if (v1parts.length !== v2parts.length) {
      return -1;
    }

    return 0;
  }
}; // Initializes the moduleGetSSLStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  moduleGetSSLStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtZ2V0LXNzbC1zdGF0dXMtd29ya2VyLmpzIl0sIm5hbWVzIjpbIm1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImV2ZW50U291cmNlIiwiY2hhbm5lbElkIiwiJHJlc3VsdEJsb2NrIiwiJCIsImluaXRpYWxpemUiLCJpbml0aWFsaXplQWNlIiwidmVyc2lvbkNvbXBhcmUiLCJnbG9iYWxQQlhWZXJzaW9uIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiYXBpIiwidXJsIiwiQ29uZmlnIiwicGJ4VXJsIiwib24iLCJtZXRob2QiLCJzdWNjZXNzVGVzdCIsIlBieEFwaSIsIm9uU3VjY2VzcyIsInJlc3BvbnNlIiwiZGF0YSIsInJlc3VsdCIsImxlbmd0aCIsInNob3ciLCJlZGl0b3IiLCJnZXRTZXNzaW9uIiwic2V0VmFsdWUiLCJzZXRUaW1lb3V0Iiwib25GYWlsdXJlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJtZXNzYWdlIiwiaGlkZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0Iiwicm93c0NvdW50IiwiTWF0aCIsInJvdW5kIiwibG9hZCIsImNzcyIsImFjZSIsImVkaXQiLCJOZXdNb2RlIiwicmVxdWlyZSIsIk1vZGUiLCJzZXNzaW9uIiwic2V0TW9kZSIsInNldFRoZW1lIiwicmVzaXplIiwiRm9ybSIsImRhdGFDaGFuZ2VkIiwic2V0T3B0aW9ucyIsIm1heExpbmVzIiwic2hvd1ByaW50TWFyZ2luIiwic2hvd0xpbmVOdW1iZXJzIiwibGFzdEV2ZW50SWRLZXkiLCJsYXN0RXZlbnRJZCIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJzdWJQYXRoIiwiRXZlbnRTb3VyY2UiLCJhZGRFdmVudExpc3RlbmVyIiwiZSIsIkpTT04iLCJwYXJzZSIsImNvbnNvbGUiLCJkZWJ1ZyIsInByb2Nlc3NTdGF0dXNNZXNzYWdlIiwic2V0SXRlbSIsInN0YWdlRGV0YWlscyIsInJlc3VsdFRleHQiLCJnZXRWYWx1ZSIsInN0YWdlIiwibWVzc2FnZXMiLCJ2MSIsInYyIiwib3B0aW9ucyIsImxleGljb2dyYXBoaWNhbCIsInplcm9FeHRlbmQiLCJ2MXBhcnRzIiwiU3RyaW5nIiwic3BsaXQiLCJ2MnBhcnRzIiwiaXNWYWxpZFBhcnQiLCJ4IiwidGVzdCIsImV2ZXJ5IiwiTmFOIiwicHVzaCIsIm1hcCIsIk51bWJlciIsImkiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsNEJBQTRCLEdBQUc7QUFFakM7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsT0FBTyxFQUFFLEtBTndCOztBQVFqQztBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUUsQ0Faa0I7O0FBZWpDO0FBQ0o7QUFDQTtBQUNJQyxFQUFBQSxXQUFXLEVBQUUsSUFsQm9COztBQW9CakM7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsU0FBUyxFQUFFLG9CQXhCc0I7O0FBMEJqQztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFlBQVksRUFBRUMsQ0FBQyxDQUFDLGFBQUQsQ0EvQmtCOztBQWlDakM7QUFDSjtBQUNBO0FBQ0lDLEVBQUFBLFVBcENpQyx3QkFvQ3JCO0FBQ1JQLElBQUFBLDRCQUE0QixDQUFDUSxhQUE3Qjs7QUFDQSxRQUFJUiw0QkFBNEIsQ0FBQ1MsY0FBN0IsQ0FBNENDLGdCQUE1QyxFQUE2RCxXQUE3RCxJQUEwRSxDQUE5RSxFQUFnRjtBQUM1RVYsTUFBQUEsNEJBQTRCLENBQUNXLDRCQUE3QjtBQUNILEtBRkQs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QXdDNEQsUUFBQUEsT0FBTyxDQUFDTSxJQUFSLENBQWEsR0FBYjtBQUF4QztBQUNIOztBQUVELFFBQUksQ0FBQ1gsZUFBTCxFQUFzQjtBQUNsQkUsTUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNVLEdBQVIsQ0FBWUMsTUFBWixDQUFWO0FBQ0FSLE1BQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUFDTyxHQUFSLENBQVlDLE1BQVosQ0FBVjtBQUNIOztBQUVELFNBQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR1osT0FBTyxDQUFDekQsTUFBNUIsRUFBb0NxRSxDQUFDLElBQUksQ0FBekMsRUFBNEM7QUFDeEMsVUFBSVQsT0FBTyxDQUFDNUQsTUFBUixLQUFtQnFFLENBQXZCLEVBQTBCO0FBQ3RCLGVBQU8sQ0FBUDtBQUNIOztBQUNELFVBQUlaLE9BQU8sQ0FBQ1ksQ0FBRCxDQUFQLEtBQWVULE9BQU8sQ0FBQ1MsQ0FBRCxDQUExQixFQUErQixDQUMzQjtBQUNILE9BRkQsTUFFTyxJQUFJWixPQUFPLENBQUNZLENBQUQsQ0FBUCxHQUFhVCxPQUFPLENBQUNTLENBQUQsQ0FBeEIsRUFBNkI7QUFDaEMsZUFBTyxDQUFQO0FBQ0gsT0FGTSxNQUVBO0FBQ0gsZUFBTyxDQUFDLENBQVI7QUFDSDtBQUNKOztBQUVELFFBQUlaLE9BQU8sQ0FBQ3pELE1BQVIsS0FBbUI0RCxPQUFPLENBQUM1RCxNQUEvQixFQUF1QztBQUNuQyxhQUFPLENBQUMsQ0FBUjtBQUNIOztBQUVELFdBQU8sQ0FBUDtBQUNIO0FBL01nQyxDQUFyQyxDLENBbU5BOztBQUNBdkIsQ0FBQyxDQUFDNkYsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQnBHLEVBQUFBLDRCQUE0QixDQUFDTyxVQUE3QjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlICovXG5cbi8qKlxuICogQG1vZHVsZSBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyXG4gKi9cbmNvbnN0IG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgZmV0Y2hpbmcgbmV3IHN0YXR1cy5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDEwMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3Igc3RhdHVzIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cblxuICAgIC8qKi5cbiAgICAgKiBAdHlwZSB7RXZlbnRTb3VyY2V9XG4gICAgICovXG4gICAgZXZlbnRTb3VyY2U6IG51bGwsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWRlbnRpZmllciBmb3IgdGhlIFBVQi9TVUIgY2hhbm5lbCB1c2VkIHRvIHN1YnNjcmliZSB0byBtb2R1bGUgc3RhdHVzIHVwZGF0ZXMuXG4gICAgICogVGhpcyBlbnN1cmVzIHRoYXQgdGhlIGNsaWVudCBpcyBsaXN0ZW5pbmcgb24gdGhlIGNvcnJlY3QgY2hhbm5lbCBmb3IgcmVsZXZhbnQgZXZlbnRzLlxuICAgICAqL1xuICAgIGNoYW5uZWxJZDogJ21vZHVsZS1nZXQtc3NsLXB1YicsXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgc2VsZWN0b3IgZm9yIHRoZSByZXN1bHQgbWVzc2FnZSBlbGVtZW50LlxuICAgICAqXG4gICAgICogVGhpcyBwcm9wZXJ0eSBzdG9yZXMgYSByZWZlcmVuY2UgdG8gdGhlIERPTSBlbGVtZW50IHdpdGggdGhlIElEICdkaXYtcmVzdWx0JyB1c2luZyBqUXVlcnkuXG4gICAgICovXG4gICAgJHJlc3VsdEJsb2NrOiAkKCcjZGl2LXJlc3VsdCcpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIgbW9kdWxlIGJ5IHNldHRpbmcgdXAgdGhlIGNvbm5lY3Rpb24gdG8gcmVjZWl2ZSBzZXJ2ZXItc2VudCBldmVudHMuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpe1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemVBY2UoKTtcbiAgICAgICAgaWYgKG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIudmVyc2lvbkNvbXBhcmUoZ2xvYmFsUEJYVmVyc2lvbiwnMjAyNC4yLjMwJyk+MCl7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnN0YXJ0TGlzdGVuUHVzaE5vdGlmaWNhdGlvbnMoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBtb2R1bGVHZXRTU0xTdGF0dXMgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQobW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogV29ya2VyIGZ1bmN0aW9uIGZvciBmZXRjaGluZyBzdGF0dXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke0NvbmZpZy5wYnhVcmx9L3BieGNvcmUvYXBpL21vZHVsZXMvTW9kdWxlR2V0U3NsL2NoZWNrLXJlc3VsdGAsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3Q6IFBieEFwaS5zdWNjZXNzVGVzdCxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogSGFuZGxlcyB0aGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBvZiB0aGUgJ2NoZWNrLXJlc3VsdCcgQVBJIHJlcXVlc3QuXG4gICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBvblN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHJlc3BvbnNlLmRhdGEucmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIud29ya2VyLFxuICAgICAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEhhbmRsZXMgdGhlIGZhaWx1cmUgcmVzcG9uc2Ugb2YgdGhlICdnZXQtYXZhaWxhYmxlLWxkYXAtdXNlcnMnIEFQSSByZXF1ZXN0LlxuICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdC5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgb25GYWlsdXJlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5oaWRlKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgQWNlIGVkaXRvciBpbnN0YW5jZS5cbiAgICAgKiBTZXRzIHVwIEFjZSBlZGl0b3Igd2l0aCBhIG1vbm9rYWkgdGhlbWUgYW5kIGN1c3RvbSBvcHRpb25zLlxuICAgICAqIEF0dGFjaGVzIGNoYW5nZSBoYW5kbGVyIHRvIHRoZSBlZGl0b3Igc2Vzc2lvbi5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplQWNlKCkge1xuICAgICAgICBjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSA0ODA7XG4gICAgICAgIGNvbnN0IHJvd3NDb3VudCA9IE1hdGgucm91bmQoYWNlSGVpZ2h0IC8gMTYuMyk7XG4gICAgICAgICQod2luZG93KS5sb2FkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICQoJy5hcHBsaWNhdGlvbi1jb2RlJykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG4gICAgICAgIH0pO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvciA9IGFjZS5lZGl0KCd1c2VyLWVkaXQtY29uZmlnJyk7XG4gICAgICAgIGxldCBOZXdNb2RlID0gYWNlLnJlcXVpcmUoJ2FjZS9tb2RlL2p1bGlhJykuTW9kZTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKG5ldyBOZXdNb2RlKCkpO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IucmVzaXplKCk7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLmdldFNlc3Npb24oKS5vbignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gVHJpZ2dlciBjaGFuZ2UgZXZlbnQgdG8gYWNrbm93bGVkZ2UgdGhlIG1vZGlmaWNhdGlvblxuICAgICAgICAgICAgRm9ybS5kYXRhQ2hhbmdlZCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIG1heExpbmVzOiByb3dzQ291bnQsXG4gICAgICAgICAgICBzaG93UHJpbnRNYXJnaW46IGZhbHNlLFxuICAgICAgICAgICAgc2hvd0xpbmVOdW1iZXJzOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB0byBzdGFydCByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgb24gbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKiBVdGlsaXplcyB0aGUgRXZlbnRTb3VyY2UgQVBJIHRvIGxpc3RlbiBmb3IgbWVzc2FnZXMgb24gYSBzcGVjaWZpZWQgY2hhbm5lbC5cbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGAke21vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfS1sYXN0RXZlbnRJZGA7XG4gICAgICAgIGxldCBsYXN0RXZlbnRJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGxhc3RFdmVudElkS2V5KTtcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IGxhc3RFdmVudElkID8gYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHttb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH0/bGFzdF9ldmVudF9pZD0ke2xhc3RFdmVudElkfWAgOiBgL3BieGNvcmUvYXBpL25jaGFuL3N1Yi8ke21vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfWA7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2Uoc3ViUGF0aCk7XG5cbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5ldmVudFNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoZS5kYXRhKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcocmVzcG9uc2UpO1xuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5wcm9jZXNzU3RhdHVzTWVzc2FnZShyZXNwb25zZSk7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShsYXN0RXZlbnRJZEtleSwgZS5sYXN0RXZlbnRJZCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSBkYXRhIHBheWxvYWQgb2YgdGhlIHNlcnZlci1zZW50IGV2ZW50LCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBzdGFnZSBhbmQgcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgcHJvY2Vzc1N0YXR1c01lc3NhZ2UocmVzcG9uc2Upe1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLnJlc3VsdCl7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5zaG93KCk7XG4gICAgICAgICAgICBsZXQgcmVzdWx0VGV4dCA9IG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRWYWx1ZSgpO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfMV9HRU5FUkFURV9DT05GSUcnKXtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ICs9ICdcXG4nICsgcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfMl9SRVFVRVNUX0NFUlQnKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0VGV4dCArPSAnXFxuJyArIHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5zdGFnZSA9PT0gJ1NUQUdFXzNfUEFSU0VfUkVTUE9OU0UnICYmIHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0VGV4dCA9IHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5zdGFnZSA9PT0gJ1NUQUdFXzRfRklOQUxfUkVTVUxUJyAmJiByZXNwb25zZS5zdGFnZURldGFpbHMuZGF0YS5yZXN1bHQubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHJlc3VsdFRleHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLnN0YWdlRGV0YWlscy5tZXNzYWdlcyk7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5oaWRlKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ29tcGFyZSB2ZXJzaW9ucyBvZiBtb2R1bGVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2MSAtIFRoZSBmaXJzdCB2ZXJzaW9uIHRvIGNvbXBhcmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHYyIC0gVGhlIHNlY29uZCB2ZXJzaW9uIHRvIGNvbXBhcmUuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxleGljb2dyYXBoaWNhbF0gLSBXaGV0aGVyIHRvIHBlcmZvcm0gbGV4aWNvZ3JhcGhpY2FsIGNvbXBhcmlzb24gKGRlZmF1bHQ6IGZhbHNlKS5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnplcm9FeHRlbmRdIC0gV2VhdGhlciB0byB6ZXJvLWV4dGVuZCB0aGUgc2hvcnRlciB2ZXJzaW9uIChkZWZhdWx0OiBmYWxzZSkuXG4gICAgICogQHJldHVybnMge251bWJlcn0gLSBBIG51bWJlciBpbmRpY2F0aW5nIHRoZSBjb21wYXJpc29uIHJlc3VsdDogMCBpZiB2ZXJzaW9ucyBhcmUgZXF1YWwsIDEgaWYgdjEgaXMgZ3JlYXRlciwgLTEgaWYgdjIgaXMgZ3JlYXRlciwgb3IgTmFOIGlmIHRoZSB2ZXJzaW9ucyBhcmUgaW52YWxpZC5cbiAgICAgKi9cbiAgICB2ZXJzaW9uQ29tcGFyZSh2MSwgdjIsIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgbGV4aWNvZ3JhcGhpY2FsID0gb3B0aW9ucyAmJiBvcHRpb25zLmxleGljb2dyYXBoaWNhbDtcbiAgICAgICAgY29uc3QgemVyb0V4dGVuZCA9IG9wdGlvbnMgJiYgb3B0aW9ucy56ZXJvRXh0ZW5kO1xuICAgICAgICBsZXQgdjFwYXJ0cyA9IFN0cmluZyh2MSkuc3BsaXQoJy4nKTtcbiAgICAgICAgbGV0IHYycGFydHMgPSBTdHJpbmcodjIpLnNwbGl0KCcuJyk7XG5cbiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZFBhcnQoeCkge1xuICAgICAgICAgICAgcmV0dXJuIChsZXhpY29ncmFwaGljYWwgPyAvXlxcZCtbQS1aYS16XSokLyA6IC9eXFxkKyQvKS50ZXN0KHgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF2MXBhcnRzLmV2ZXJ5KGlzVmFsaWRQYXJ0KSB8fCAhdjJwYXJ0cy5ldmVyeShpc1ZhbGlkUGFydCkpIHtcbiAgICAgICAgICAgIHJldHVybiBOYU47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoemVyb0V4dGVuZCkge1xuICAgICAgICAgICAgd2hpbGUgKHYxcGFydHMubGVuZ3RoIDwgdjJwYXJ0cy5sZW5ndGgpIHYxcGFydHMucHVzaCgnMCcpO1xuICAgICAgICAgICAgd2hpbGUgKHYycGFydHMubGVuZ3RoIDwgdjFwYXJ0cy5sZW5ndGgpIHYycGFydHMucHVzaCgnMCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFsZXhpY29ncmFwaGljYWwpIHtcbiAgICAgICAgICAgIHYxcGFydHMgPSB2MXBhcnRzLm1hcChOdW1iZXIpO1xuICAgICAgICAgICAgdjJwYXJ0cyA9IHYycGFydHMubWFwKE51bWJlcik7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHYxcGFydHMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmICh2MnBhcnRzLmxlbmd0aCA9PT0gaSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHYxcGFydHNbaV0gPT09IHYycGFydHNbaV0pIHtcbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2MXBhcnRzW2ldID4gdjJwYXJ0c1tpXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodjFwYXJ0cy5sZW5ndGggIT09IHYycGFydHMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gMDtcbiAgICB9LFxuXG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlciBtb2R1bGUgd2hlbiB0aGUgRE9NIGlzIGZ1bGx5IGxvYWRlZC5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUoKTtcbn0pOyJdfQ==