"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * @module moduleGetSSLStatusLoopWorker
 */
var moduleGetSSLStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status.
   * @type {number}
   */
  timeOut: 10000,

  /**
   * The id of the timer function for status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to module status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'module-get-ssl-pub',

  /**
   * jQuery selector for the result message element.
   *
   * This property stores a reference to the DOM element with the ID 'div-result' using jQuery.
   */
  $resultBlock: $('#div-result'),

  /**
   * Initializes the moduleGetSSLStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    moduleGetSSLStatusLoopWorker.initializeAce();
    moduleGetSSLStatusLoopWorker.loadLastLog();

    if (moduleGetSSLStatusLoopWorker.versionCompare(globalPBXVersion, '2024.2.30') > 0) {
      moduleGetSSLStatusLoopWorker.startListenPushNotifications();
    } else {
      moduleGetSSLStatusLoopWorker.restartWorker();
    }
  },

  /**
   * Loads the last log file content into the ACE editor on page load.
   */
  loadLastLog: function loadLastLog() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModuleGetSsl/check-result"),
      on: 'now',
      method: 'GET',
      successTest: PbxApi.successTest,
      onSuccess: function onSuccess(response) {
        if (response.data.result && response.data.result.length > 0) {
          moduleGetSSLStatusLoopWorker.$resultBlock.show();
          moduleGetSSLStatusLoopWorker.editor.getSession().setValue(response.data.result);
        }
      },
      onFailure: function onFailure() {// Silently ignore - no log to show
      }
    });
  },

  /**
   * Restarts the moduleGetSSLStatus worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(moduleGetSSLStatusLoopWorker.timeoutHandle);
    moduleGetSSLStatusLoopWorker.worker();
  },

  /**
   * Worker function for fetching status.
   */
  worker: function worker() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/ModuleGetSsl/check-result"),
      on: 'now',
      method: 'GET',
      successTest: PbxApi.successTest,

      /**
       * Handles the successful response of the 'check-result' API request.
       * @param {object} response - The response object.
       */
      onSuccess: function onSuccess(response) {
        if (response.data.result.length > 0) {
          moduleGetSSLStatusLoopWorker.$resultBlock.show();
          moduleGetSSLStatusLoopWorker.editor.getSession().setValue(response.data.result);
        }

        moduleGetSSLStatusLoopWorker.timeoutHandle = window.setTimeout(moduleGetSSLStatusLoopWorker.worker, moduleGetSSLStatusLoopWorker.timeOut);
      },

      /**
       * Handles the failure response of the 'get-available-ldap-users' API request.
       * @param {object} response - The response object.
       */
      onFailure: function onFailure(response) {
        UserMessage.showMultiString(response.message);
        moduleGetSSLStatusLoopWorker.$resultBlock.hide();
      }
    });
  },

  /**
   * Initializes the Ace editor instance.
   * Sets up Ace editor with a monokai theme and custom options.
   * Attaches change handler to the editor session.
   */
  initializeAce: function initializeAce() {
    var aceHeight = window.innerHeight - 480;
    var rowsCount = Math.round(aceHeight / 16.3);
    $(window).load(function () {
      $('.application-code').css('min-height', "".concat(aceHeight, "px"));
    });
    moduleGetSSLStatusLoopWorker.editor = ace.edit('user-edit-config');

    var NewMode = ace.require('ace/mode/julia').Mode;

    moduleGetSSLStatusLoopWorker.editor.session.setMode(new NewMode());
    moduleGetSSLStatusLoopWorker.editor.setTheme('ace/theme/monokai');
    moduleGetSSLStatusLoopWorker.editor.resize();
    moduleGetSSLStatusLoopWorker.editor.getSession().on('change', function () {
      // Trigger change event to acknowledge the modification
      Form.dataChanged();
    });
    moduleGetSSLStatusLoopWorker.editor.setOptions({
      maxLines: rowsCount,
      showPrintMargin: false,
      showLineNumbers: false
    });
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "".concat(moduleGetSSLStatusLoopWorker.channelId, "-lastEventId");
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(moduleGetSSLStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(moduleGetSSLStatusLoopWorker.channelId);
    moduleGetSSLStatusLoopWorker.eventSource = new EventSource(subPath);
    moduleGetSSLStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      console.debug(response);
      moduleGetSSLStatusLoopWorker.processStatusMessage(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processStatusMessage: function processStatusMessage(response) {
    if (response.stageDetails.result) {
      moduleGetSSLStatusLoopWorker.$resultBlock.show();
      var resultText = moduleGetSSLStatusLoopWorker.editor.getSession().getValue();

      if (response.stage === 'STAGE_1_GENERATE_CONFIG') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_2_REQUEST_CERT') {
        resultText += '\n' + response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_3_PARSE_RESPONSE' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      } else if (response.stage === 'STAGE_4_FINAL_RESULT' && response.stageDetails.data.result.length > 0) {
        resultText = response.stageDetails.data.result;
      }

      moduleGetSSLStatusLoopWorker.editor.getSession().setValue(resultText);
    } else {
      UserMessage.showMultiString(response.stageDetails.messages);
      moduleGetSSLStatusLoopWorker.$resultBlock.hide();
    }
  },

  /**
   * Compare versions of modules.
   * @param {string} v1 - The first version to compare.
   * @param {string} v2 - The second version to compare.
   * @param {object} [options] - Optional configuration options.
   * @param {boolean} [options.lexicographical] - Whether to perform lexicographical comparison (default: false).
   * @param {boolean} [options.zeroExtend] - Weather to zero-extend the shorter version (default: false).
   * @returns {number} - A number indicating the comparison result: 0 if versions are equal, 1 if v1 is greater, -1 if v2 is greater, or NaN if the versions are invalid.
   */
  versionCompare: function versionCompare(v1, v2, options) {
    var lexicographical = options && options.lexicographical;
    var zeroExtend = options && options.zeroExtend;
    var v1parts = String(v1).split('.');
    var v2parts = String(v2).split('.');

    function isValidPart(x) {
      return (lexicographical ? /^\d+[A-Za-z]*$/ : /^\d+$/).test(x);
    }

    if (!v1parts.every(isValidPart) || !v2parts.every(isValidPart)) {
      return NaN;
    }

    if (zeroExtend) {
      while (v1parts.length < v2parts.length) {
        v1parts.push('0');
      }

      while (v2parts.length < v1parts.length) {
        v2parts.push('0');
      }
    }

    if (!lexicographical) {
      v1parts = v1parts.map(Number);
      v2parts = v2parts.map(Number);
    }

    for (var i = 0; i < v1parts.length; i += 1) {
      if (v2parts.length === i) {
        return 1;
      }

      if (v1parts[i] === v2parts[i]) {//
      } else if (v1parts[i] > v2parts[i]) {
        return 1;
      } else {
        return -1;
      }
    }

    if (v1parts.length !== v2parts.length) {
      return -1;
    }

    return 0;
  }
}; // Initializes the moduleGetSSLStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  moduleGetSSLStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtZ2V0LXNzbC1zdGF0dXMtd29ya2VyLmpzIl0sIm5hbWVzIjpbIm1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImV2ZW50U291cmNlIiwiY2hhbm5lbElkIiwiJHJlc3VsdEJsb2NrIiwiJCIsImluaXRpYWxpemUiLCJpbml0aWFsaXplQWNlIiwibG9hZExhc3RMb2ciLCJ2ZXJzaW9uQ29tcGFyZSIsImdsb2JhbFBCWFZlcnNpb24iLCJzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zIiwicmVzdGFydFdvcmtlciIsImFwaSIsInVybCIsIkNvbmZpZyIsInBieFVybCIsIm9uIiwibWV0aG9kIiwic3VjY2Vzc1Rlc3QiLCJQYnhBcGkiLCJvblN1Y2Nlc3MiLCJyZXNwb25zZSIsImRhdGEiLCJyZXN1bHQiLCJsZW5ndGgiLCJzaG93IiwiZWRpdG9yIiwiZ2V0U2Vzc2lvbiIsInNldFZhbHVlIiwib25GYWlsdXJlIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsInNldFRpbWVvdXQiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsIm1lc3NhZ2UiLCJoaWRlIiwiYWNlSGVpZ2h0IiwiaW5uZXJIZWlnaHQiLCJyb3dzQ291bnQiLCJNYXRoIiwicm91bmQiLCJsb2FkIiwiY3NzIiwiYWNlIiwiZWRpdCIsIk5ld01vZGUiLCJyZXF1aXJlIiwiTW9kZSIsInNlc3Npb24iLCJzZXRNb2RlIiwic2V0VGhlbWUiLCJyZXNpemUiLCJGb3JtIiwiZGF0YUNoYW5nZWQiLCJzZXRPcHRpb25zIiwibWF4TGluZXMiLCJzaG93UHJpbnRNYXJnaW4iLCJzaG93TGluZU51bWJlcnMiLCJsYXN0RXZlbnRJZEtleSIsImxhc3RFdmVudElkIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsInN1YlBhdGgiLCJFdmVudFNvdXJjZSIsImFkZEV2ZW50TGlzdGVuZXIiLCJlIiwiSlNPTiIsInBhcnNlIiwiY29uc29sZSIsImRlYnVnIiwicHJvY2Vzc1N0YXR1c01lc3NhZ2UiLCJzZXRJdGVtIiwic3RhZ2VEZXRhaWxzIiwicmVzdWx0VGV4dCIsImdldFZhbHVlIiwic3RhZ2UiLCJtZXNzYWdlcyIsInYxIiwidjIiLCJvcHRpb25zIiwibGV4aWNvZ3JhcGhpY2FsIiwiemVyb0V4dGVuZCIsInYxcGFydHMiLCJTdHJpbmciLCJzcGxpdCIsInYycGFydHMiLCJpc1ZhbGlkUGFydCIsIngiLCJ0ZXN0IiwiZXZlcnkiLCJOYU4iLCJwdXNoIiwibWFwIiwiTnVtYmVyIiwiaSIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSw0QkFBNEIsR0FBRztBQUVqQztBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsS0FOd0I7O0FBUWpDO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGFBQWEsRUFBRSxDQVprQjs7QUFlakM7QUFDSjtBQUNBO0FBQ0lDLEVBQUFBLFdBQVcsRUFBRSxJQWxCb0I7O0FBb0JqQztBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxTQUFTLEVBQUUsb0JBeEJzQjs7QUEwQmpDO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsWUFBWSxFQUFFQyxDQUFDLENBQUMsYUFBRCxDQS9Ca0I7O0FBaUNqQztBQUNKO0FBQ0E7QUFDSUMsRUFBQUEsVUFwQ2lDLHdCQW9DckI7QUFDUlAsSUFBQUEsNEJBQTRCLENBQUNRLGFBQTdCO0FBQ0FSLElBQUFBLDRCQUE0QixDQUFDUyxXQUE3Qjs7QUFDQSxRQUFJVCw0QkFBNEIsQ0FBQ1UsY0FBN0IsQ0FBNENDLGdCQUE1QyxFQUE2RCxXQUE3RCxJQUEwRSxDQUE5RSxFQUFn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QyxJQUFJLENBQXpDLEVBQTRDO0FBQ3hDLFVBQUlULE9BQU8sQ0FBQ2hFLE1BQVIsS0FBbUJ5RSxDQUF2QixFQUEwQjtBQUN0QixlQUFPLENBQVA7QUFDSDs7QUFDRCxVQUFJWixPQUFPLENBQUNZLENBQUQsQ0FBUCxLQUFlVCxPQUFPLENBQUNTLENBQUQsQ0FBMUIsRUFBK0IsQ0FDM0I7QUFDSCxPQUZELE1BRU8sSUFBSVosT0FBTyxDQUFDWSxDQUFELENBQVAsR0FBYVQsT0FBTyxDQUFDUyxDQUFELENBQXhCLEVBQTZCO0FBQ2hDLGVBQU8sQ0FBUDtBQUNILE9BRk0sTUFFQTtBQUNILGVBQU8sQ0FBQyxDQUFSO0FBQ0g7QUFDSjs7QUFFRCxRQUFJWixPQUFPLENBQUM3RCxNQUFSLEtBQW1CZ0UsT0FBTyxDQUFDaEUsTUFBL0IsRUFBdUM7QUFDbkMsYUFBTyxDQUFDLENBQVI7QUFDSDs7QUFFRCxXQUFPLENBQVA7QUFDSDtBQXJPZ0MsQ0FBckMsQyxDQXlPQTs7QUFDQXBCLENBQUMsQ0FBQzhGLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEJyRyxFQUFBQSw0QkFBNEIsQ0FBQ08sVUFBN0I7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIFBieEFwaSwgZ2xvYmFsVHJhbnNsYXRlLCBVc2VyTWVzc2FnZSAqL1xuXG4vKipcbiAqIEBtb2R1bGUgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlclxuICovXG5jb25zdCBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBzdGF0dXMuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAxMDAwMCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBpZCBvZiB0aGUgdGltZXIgZnVuY3Rpb24gZm9yIHN0YXR1cyB3b3JrZXIuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0SGFuZGxlOiAwLFxuXG5cbiAgICAvKiouXG4gICAgICogQHR5cGUge0V2ZW50U291cmNlfVxuICAgICAqL1xuICAgIGV2ZW50U291cmNlOiBudWxsLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkZW50aWZpZXIgZm9yIHRoZSBQVUIvU1VCIGNoYW5uZWwgdXNlZCB0byBzdWJzY3JpYmUgdG8gbW9kdWxlIHN0YXR1cyB1cGRhdGVzLlxuICAgICAqIFRoaXMgZW5zdXJlcyB0aGF0IHRoZSBjbGllbnQgaXMgbGlzdGVuaW5nIG9uIHRoZSBjb3JyZWN0IGNoYW5uZWwgZm9yIHJlbGV2YW50IGV2ZW50cy5cbiAgICAgKi9cbiAgICBjaGFubmVsSWQ6ICdtb2R1bGUtZ2V0LXNzbC1wdWInLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IHNlbGVjdG9yIGZvciB0aGUgcmVzdWx0IG1lc3NhZ2UgZWxlbWVudC5cbiAgICAgKlxuICAgICAqIFRoaXMgcHJvcGVydHkgc3RvcmVzIGEgcmVmZXJlbmNlIHRvIHRoZSBET00gZWxlbWVudCB3aXRoIHRoZSBJRCAnZGl2LXJlc3VsdCcgdXNpbmcgalF1ZXJ5LlxuICAgICAqL1xuICAgICRyZXN1bHRCbG9jazogJCgnI2Rpdi1yZXN1bHQnKSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyIG1vZHVsZSBieSBzZXR0aW5nIHVwIHRoZSBjb25uZWN0aW9uIHRvIHJlY2VpdmUgc2VydmVyLXNlbnQgZXZlbnRzLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKXtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5pbml0aWFsaXplQWNlKCk7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIubG9hZExhc3RMb2coKTtcbiAgICAgICAgaWYgKG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIudmVyc2lvbkNvbXBhcmUoZ2xvYmFsUEJYVmVyc2lvbiwnMjAyNC4yLjMwJyk+MCl7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnN0YXJ0TGlzdGVuUHVzaE5vdGlmaWNhdGlvbnMoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIExvYWRzIHRoZSBsYXN0IGxvZyBmaWxlIGNvbnRlbnQgaW50byB0aGUgQUNFIGVkaXRvciBvbiBwYWdlIGxvYWQuXG4gICAgICovXG4gICAgbG9hZExhc3RMb2coKSB7XG4gICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgIHVybDogYCR7Q29uZmlnLnBieFVybH0vcGJ4Y29yZS9hcGkvbW9kdWxlcy9Nb2R1bGVHZXRTc2wvY2hlY2stcmVzdWx0YCxcbiAgICAgICAgICAgIG9uOiAnbm93JyxcbiAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICBzdWNjZXNzVGVzdDogUGJ4QXBpLnN1Y2Nlc3NUZXN0LFxuICAgICAgICAgICAgb25TdWNjZXNzOiBmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS5yZXN1bHQgJiYgcmVzcG9uc2UuZGF0YS5yZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRWYWx1ZShyZXNwb25zZS5kYXRhLnJlc3VsdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uRmFpbHVyZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgLy8gU2lsZW50bHkgaWdub3JlIC0gbm8gbG9nIHRvIHNob3dcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBtb2R1bGVHZXRTU0xTdGF0dXMgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQobW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogV29ya2VyIGZ1bmN0aW9uIGZvciBmZXRjaGluZyBzdGF0dXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke0NvbmZpZy5wYnhVcmx9L3BieGNvcmUvYXBpL21vZHVsZXMvTW9kdWxlR2V0U3NsL2NoZWNrLXJlc3VsdGAsXG4gICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3Q6IFBieEFwaS5zdWNjZXNzVGVzdCxcbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogSGFuZGxlcyB0aGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBvZiB0aGUgJ2NoZWNrLXJlc3VsdCcgQVBJIHJlcXVlc3QuXG4gICAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBvblN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHJlc3BvbnNlLmRhdGEucmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIud29ya2VyLFxuICAgICAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIEhhbmRsZXMgdGhlIGZhaWx1cmUgcmVzcG9uc2Ugb2YgdGhlICdnZXQtYXZhaWxhYmxlLWxkYXAtdXNlcnMnIEFQSSByZXF1ZXN0LlxuICAgICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdC5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgb25GYWlsdXJlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5oaWRlKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgQWNlIGVkaXRvciBpbnN0YW5jZS5cbiAgICAgKiBTZXRzIHVwIEFjZSBlZGl0b3Igd2l0aCBhIG1vbm9rYWkgdGhlbWUgYW5kIGN1c3RvbSBvcHRpb25zLlxuICAgICAqIEF0dGFjaGVzIGNoYW5nZSBoYW5kbGVyIHRvIHRoZSBlZGl0b3Igc2Vzc2lvbi5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplQWNlKCkge1xuICAgICAgICBjb25zdCBhY2VIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSA0ODA7XG4gICAgICAgIGNvbnN0IHJvd3NDb3VudCA9IE1hdGgucm91bmQoYWNlSGVpZ2h0IC8gMTYuMyk7XG4gICAgICAgICQod2luZG93KS5sb2FkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICQoJy5hcHBsaWNhdGlvbi1jb2RlJykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG4gICAgICAgIH0pO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvciA9IGFjZS5lZGl0KCd1c2VyLWVkaXQtY29uZmlnJyk7XG4gICAgICAgIGxldCBOZXdNb2RlID0gYWNlLnJlcXVpcmUoJ2FjZS9tb2RlL2p1bGlhJykuTW9kZTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKG5ldyBOZXdNb2RlKCkpO1xuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IucmVzaXplKCk7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLmdldFNlc3Npb24oKS5vbignY2hhbmdlJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gVHJpZ2dlciBjaGFuZ2UgZXZlbnQgdG8gYWNrbm93bGVkZ2UgdGhlIG1vZGlmaWNhdGlvblxuICAgICAgICAgICAgRm9ybS5kYXRhQ2hhbmdlZCgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIG1heExpbmVzOiByb3dzQ291bnQsXG4gICAgICAgICAgICBzaG93UHJpbnRNYXJnaW46IGZhbHNlLFxuICAgICAgICAgICAgc2hvd0xpbmVOdW1iZXJzOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB0byBzdGFydCByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgb24gbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKiBVdGlsaXplcyB0aGUgRXZlbnRTb3VyY2UgQVBJIHRvIGxpc3RlbiBmb3IgbWVzc2FnZXMgb24gYSBzcGVjaWZpZWQgY2hhbm5lbC5cbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGAke21vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfS1sYXN0RXZlbnRJZGA7XG4gICAgICAgIGxldCBsYXN0RXZlbnRJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGxhc3RFdmVudElkS2V5KTtcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IGxhc3RFdmVudElkID8gYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHttb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH0/bGFzdF9ldmVudF9pZD0ke2xhc3RFdmVudElkfWAgOiBgL3BieGNvcmUvYXBpL25jaGFuL3N1Yi8ke21vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfWA7XG4gICAgICAgIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2Uoc3ViUGF0aCk7XG5cbiAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5ldmVudFNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoZS5kYXRhKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcocmVzcG9uc2UpO1xuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5wcm9jZXNzU3RhdHVzTWVzc2FnZShyZXNwb25zZSk7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShsYXN0RXZlbnRJZEtleSwgZS5sYXN0RXZlbnRJZCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSBkYXRhIHBheWxvYWQgb2YgdGhlIHNlcnZlci1zZW50IGV2ZW50LCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBzdGFnZSBhbmQgcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgcHJvY2Vzc1N0YXR1c01lc3NhZ2UocmVzcG9uc2Upe1xuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLnJlc3VsdCl7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5zaG93KCk7XG4gICAgICAgICAgICBsZXQgcmVzdWx0VGV4dCA9IG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuZWRpdG9yLmdldFNlc3Npb24oKS5nZXRWYWx1ZSgpO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfMV9HRU5FUkFURV9DT05GSUcnKXtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ICs9ICdcXG4nICsgcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfSBlbHNlIGlmKHJlc3BvbnNlLnN0YWdlID09PSAnU1RBR0VfMl9SRVFVRVNUX0NFUlQnKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0VGV4dCArPSAnXFxuJyArIHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5zdGFnZSA9PT0gJ1NUQUdFXzNfUEFSU0VfUkVTUE9OU0UnICYmIHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0VGV4dCA9IHJlc3BvbnNlLnN0YWdlRGV0YWlscy5kYXRhLnJlc3VsdDtcbiAgICAgICAgICAgIH0gZWxzZSBpZihyZXNwb25zZS5zdGFnZSA9PT0gJ1NUQUdFXzRfRklOQUxfUkVTVUxUJyAmJiByZXNwb25zZS5zdGFnZURldGFpbHMuZGF0YS5yZXN1bHQubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRUZXh0ID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzLmRhdGEucmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHJlc3VsdFRleHQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLnN0YWdlRGV0YWlscy5tZXNzYWdlcyk7XG4gICAgICAgICAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLiRyZXN1bHRCbG9jay5oaWRlKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ29tcGFyZSB2ZXJzaW9ucyBvZiBtb2R1bGVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2MSAtIFRoZSBmaXJzdCB2ZXJzaW9uIHRvIGNvbXBhcmUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHYyIC0gVGhlIHNlY29uZCB2ZXJzaW9uIHRvIGNvbXBhcmUuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbmFsIGNvbmZpZ3VyYXRpb24gb3B0aW9ucy5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxleGljb2dyYXBoaWNhbF0gLSBXaGV0aGVyIHRvIHBlcmZvcm0gbGV4aWNvZ3JhcGhpY2FsIGNvbXBhcmlzb24gKGRlZmF1bHQ6IGZhbHNlKS5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnplcm9FeHRlbmRdIC0gV2VhdGhlciB0byB6ZXJvLWV4dGVuZCB0aGUgc2hvcnRlciB2ZXJzaW9uIChkZWZhdWx0OiBmYWxzZSkuXG4gICAgICogQHJldHVybnMge251bWJlcn0gLSBBIG51bWJlciBpbmRpY2F0aW5nIHRoZSBjb21wYXJpc29uIHJlc3VsdDogMCBpZiB2ZXJzaW9ucyBhcmUgZXF1YWwsIDEgaWYgdjEgaXMgZ3JlYXRlciwgLTEgaWYgdjIgaXMgZ3JlYXRlciwgb3IgTmFOIGlmIHRoZSB2ZXJzaW9ucyBhcmUgaW52YWxpZC5cbiAgICAgKi9cbiAgICB2ZXJzaW9uQ29tcGFyZSh2MSwgdjIsIG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgbGV4aWNvZ3JhcGhpY2FsID0gb3B0aW9ucyAmJiBvcHRpb25zLmxleGljb2dyYXBoaWNhbDtcbiAgICAgICAgY29uc3QgemVyb0V4dGVuZCA9IG9wdGlvbnMgJiYgb3B0aW9ucy56ZXJvRXh0ZW5kO1xuICAgICAgICBsZXQgdjFwYXJ0cyA9IFN0cmluZyh2MSkuc3BsaXQoJy4nKTtcbiAgICAgICAgbGV0IHYycGFydHMgPSBTdHJpbmcodjIpLnNwbGl0KCcuJyk7XG5cbiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZFBhcnQoeCkge1xuICAgICAgICAgICAgcmV0dXJuIChsZXhpY29ncmFwaGljYWwgPyAvXlxcZCtbQS1aYS16XSokLyA6IC9eXFxkKyQvKS50ZXN0KHgpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF2MXBhcnRzLmV2ZXJ5KGlzVmFsaWRQYXJ0KSB8fCAhdjJwYXJ0cy5ldmVyeShpc1ZhbGlkUGFydCkpIHtcbiAgICAgICAgICAgIHJldHVybiBOYU47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoemVyb0V4dGVuZCkge1xuICAgICAgICAgICAgd2hpbGUgKHYxcGFydHMubGVuZ3RoIDwgdjJwYXJ0cy5sZW5ndGgpIHYxcGFydHMucHVzaCgnMCcpO1xuICAgICAgICAgICAgd2hpbGUgKHYycGFydHMubGVuZ3RoIDwgdjFwYXJ0cy5sZW5ndGgpIHYycGFydHMucHVzaCgnMCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFsZXhpY29ncmFwaGljYWwpIHtcbiAgICAgICAgICAgIHYxcGFydHMgPSB2MXBhcnRzLm1hcChOdW1iZXIpO1xuICAgICAgICAgICAgdjJwYXJ0cyA9IHYycGFydHMubWFwKE51bWJlcik7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHYxcGFydHMubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgIGlmICh2MnBhcnRzLmxlbmd0aCA9PT0gaSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHYxcGFydHNbaV0gPT09IHYycGFydHNbaV0pIHtcbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2MXBhcnRzW2ldID4gdjJwYXJ0c1tpXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiAxO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodjFwYXJ0cy5sZW5ndGggIT09IHYycGFydHMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gMDtcbiAgICB9LFxuXG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgbW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlciBtb2R1bGUgd2hlbiB0aGUgRE9NIGlzIGZ1bGx5IGxvYWRlZC5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUoKTtcbn0pOyJdfQ==