"use strict";

/* global globalRootUrl, globalTranslate, Form, Config, PbxApi, dnsProvidersMeta */
// Constants related to the form and module
var idUrl = 'module-get-ssl'; // API endpoint for SSL module

var idForm = 'module-get-ssl-form'; // Form element ID for SSL module

var className = 'ModuleGetSsl'; // Class name for this module
// Main ModuleGetSsl class definition

var ModuleGetSsl = {
  // Cache commonly used jQuery objects
  $formObj: $('#' + idForm),
  $checkBoxes: $('#' + idForm + ' .ui.checkbox'),
  $disabilityFields: $('#' + idForm + ' .disability'),
  $statusToggle: $('#module-status-toggle'),
  $submitButton: $('#submitbutton'),
  $moduleStatus: $('#status'),
  $challengeType: $('#challengeType'),
  $dnsProvider: $('#dnsProvider'),
  $httpChallengeInfo: $('#http-challenge-info'),
  $dnsSettingsBlock: $('#dns-settings-block'),
  $dnsCredentialsFields: $('#dns-credentials-fields'),
  $dnsCredentialsInput: $('input[name="dnsCredentials"]'),
  // Validation rules for the form
  validateRules: {
    domainName: {
      identifier: 'domainName',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.module_getssl_DomainNameEmpty
      }]
    }
  },

  /**
   * Initialize the module, bind event listeners, and setup the form.
   */
  initialize: function initialize() {
    // Initialize Semantic UI checkboxes
    this.$checkBoxes.checkbox(); // Initialize dropdowns

    this.$challengeType.dropdown({
      onChange: ModuleGetSsl.onChangeChallengeType
    });
    this.$dnsProvider.dropdown({
      fullTextSearch: true,
      onChange: ModuleGetSsl.onChangeDnsProvider
    }); // Check and set module status on load and when the status changes

    this.checkStatusToggle();
    window.addEventListener('ModuleStatusChanged', this.checkStatusToggle); // Initialize form with validation and submit handlers

    this.initializeForm();
    moduleGetSSLStatusLoopWorker.$resultBlock.hide(); // Restore saved state

    var currentChallenge = this.$challengeType.dropdown('get value') || 'http';
    this.onChangeChallengeType(currentChallenge);
    this.restoreSavedCredentials();
  },

  /**
   * Handle challenge type change: show/hide relevant sections.
   * @param {string} value - 'http' or 'dns'
   */
  onChangeChallengeType: function onChangeChallengeType(value) {
    if (value === 'dns') {
      ModuleGetSsl.$httpChallengeInfo.hide();
      ModuleGetSsl.$dnsSettingsBlock.show(); // Trigger provider change to render credential fields

      var currentProvider = ModuleGetSsl.$dnsProvider.dropdown('get value');

      if (currentProvider) {
        ModuleGetSsl.onChangeDnsProvider(currentProvider);
      }
    } else {
      ModuleGetSsl.$httpChallengeInfo.show();
      ModuleGetSsl.$dnsSettingsBlock.hide();
    }
  },

  /**
   * Handle DNS provider change: dynamically render credential fields.
   * @param {string} value - provider ID (e.g. 'dns_cf')
   */
  onChangeDnsProvider: function onChangeDnsProvider(value) {
    var $container = ModuleGetSsl.$dnsCredentialsFields;
    $container.empty();

    if (!value || typeof dnsProvidersMeta === 'undefined') {
      return;
    } // Find provider metadata


    var provider = dnsProvidersMeta.find(function (p) {
      return p.id === value;
    });

    if (!provider || !provider.fields) {
      return;
    } // Decode existing saved credentials for pre-filling


    var savedCreds = {};
    var encodedVal = ModuleGetSsl.$dnsCredentialsInput.val();

    if (encodedVal) {
      try {
        var decoded = atob(encodedVal);
        savedCreds = JSON.parse(decoded);
      } catch (e) {// ignore decode errors
      }
    } // Render fields


    provider.fields.forEach(function (field) {
      var savedValue = savedCreds[field["var"]] || '';
      var inputType = field.type === 'password' ? 'password' : 'text';
      var html = "\n\t\t\t\t<div class=\"field\">\n\t\t\t\t\t<label>".concat(field.label, "</label>\n\t\t\t\t\t<input type=\"").concat(inputType, "\"\n\t\t\t\t\t\t   class=\"dns-cred-input\"\n\t\t\t\t\t\t   data-var=\"").concat(field["var"], "\"\n\t\t\t\t\t\t   value=\"").concat(ModuleGetSsl.escapeHtml(savedValue), "\"\n\t\t\t\t\t\t   placeholder=\"").concat(field.label, "\">\n\t\t\t\t</div>");
      $container.append(html);
    });
  },

  /**
   * Collect DNS credential field values into base64 JSON and write to hidden input.
   */
  collectDnsCredentials: function collectDnsCredentials() {
    var challengeType = ModuleGetSsl.$challengeType.dropdown('get value');

    if (challengeType !== 'dns') {
      return;
    }

    var creds = {};
    $('.dns-cred-input').each(function () {
      var varName = $(this).data('var');
      var val = $(this).val();

      if (varName && val) {
        creds[varName] = val;
      }
    });
    var json = JSON.stringify(creds);
    var encoded = btoa(json);
    ModuleGetSsl.$dnsCredentialsInput.val(encoded);
  },

  /**
   * Restore saved credentials into the DNS provider fields on page load.
   */
  restoreSavedCredentials: function restoreSavedCredentials() {
    var currentProvider = ModuleGetSsl.$dnsProvider.dropdown('get value');

    if (currentProvider) {
      ModuleGetSsl.onChangeDnsProvider(currentProvider);
    }
  },

  /**
   * Escape HTML special characters for safe insertion into attributes.
   * @param {string} text
   * @returns {string}
   */
  escapeHtml: function escapeHtml(text) {
    var map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, function (m) {
      return map[m];
    });
  },

  /**
   * Request an SSL certificate by calling the server-side API.
   */
  getSsl: function getSsl() {
    $.api({
      url: "".concat(Config.pbxUrl, "/pbxcore/api/modules/").concat(className, "/get-cert"),
      on: 'now',
      method: 'POST',
      beforeXHR: function beforeXHR(xhr) {
        xhr.setRequestHeader('X-Async-Response-Channel-Id', moduleGetSSLStatusLoopWorker.channelId);
        xhr.setRequestHeader('X-Processor-Timeout', '120');
        return xhr;
      },
      beforeSend: function beforeSend(settings) {
        ModuleGetSsl.$submitButton.addClass('loading disabled');
        moduleGetSSLStatusLoopWorker.$resultBlock.show();
        moduleGetSSLStatusLoopWorker.editor.getSession().setValue('');
        return settings;
      },
      successTest: PbxApi.successTest,
      onSuccess: function onSuccess(response) {
        ModuleGetSsl.$submitButton.removeClass('loading disabled');
      },
      onFailure: function onFailure(response) {
        ModuleGetSsl.$submitButton.removeClass('loading disabled');
        UserMessage.showMultiString(response.message);
        moduleGetSSLStatusLoopWorker.$resultBlock.hide();
      }
    });
  },

  /**
   * Toggles the form fields and status visibility based on the module's status.
   */
  checkStatusToggle: function checkStatusToggle() {
    if (ModuleGetSsl.$statusToggle.checkbox('is checked')) {
      ModuleGetSsl.$disabilityFields.removeClass('disabled');
      ModuleGetSsl.$moduleStatus.show();
    } else {
      ModuleGetSsl.$disabilityFields.addClass('disabled');
      ModuleGetSsl.$moduleStatus.hide();
    }
  },

  /**
   * Callback before sending the form.
   * @param {Object} settings - Ajax request settings.
   * @returns {Object} The modified Ajax request settings.
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings; // Collect DNS credentials into hidden field before form submission

    ModuleGetSsl.collectDnsCredentials();
    result.data = ModuleGetSsl.$formObj.form('get values');
    return result;
  },

  /**
   * Callback function after sending the form.
   */
  cbAfterSendForm: function cbAfterSendForm(response) {
    if (Form.checkSuccess(response)) {
      ModuleGetSsl.getSsl();
    }
  },

  /**
   * Initializes the form validation and submission logic.
   */
  initializeForm: function initializeForm() {
    Form.$formObj = ModuleGetSsl.$formObj;
    Form.url = "".concat(globalRootUrl).concat(idUrl, "/").concat(idUrl, "/save");
    Form.validateRules = ModuleGetSsl.validateRules;
    Form.enableDirrity = false;
    Form.cbAfterSendForm = ModuleGetSsl.cbAfterSendForm;
    Form.cbBeforeSendForm = ModuleGetSsl.cbBeforeSendForm;
    Form.initialize();
  }
}; // Initialize the ModuleGetSsl class when the document is ready

$(document).ready(function () {
  ModuleGetSsl.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9tb2R1bGUtZ2V0LXNzbC1pbmRleC5qcyJdLCJuYW1lcyI6WyJpZFVybCIsImlkRm9ybSIsImNsYXNzTmFtZSIsIk1vZHVsZUdldFNzbCIsIiRmb3JtT2JqIiwiJCIsIiRjaGVja0JveGVzIiwiJGRpc2FiaWxpdHlGaWVsZHMiLCIkc3RhdHVzVG9nZ2xlIiwiJHN1Ym1pdEJ1dHRvbiIsIiRtb2R1bGVTdGF0dXMiLCIkY2hhbGxlbmdlVHlwZSIsIiRkbnNQcm92aWRlciIsIiRodHRwQ2hhbGxlbmdlSW5mbyIsIiRkbnNTZXR0aW5nc0Jsb2NrIiwiJGRuc0NyZWRlbnRpYWxzRmllbGRzIiwiJGRuc0NyZWRlbnRpYWxzSW5wdXQiLCJ2YWxpZGF0ZVJ1bGVzIiwiZG9tYWluTmFtZSIsImlkZW50aWZpZXIiLCJydWxlcyIsInR5cGUiLCJwcm9tcHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJtb2R1bGVfZ2V0c3NsX0RvbWFpbk5hbWVFbXB0eSIsImluaXRpYWxpemUiLCJjaGVja2JveCIsImRyb3Bkb3duIiwib25DaGFuZ2UiLCJvbkNoYW5nZUNoYWxsZW5nZVR5cGUiLCJmdWxsVGV4dFNlYXJjaCIsIm9uQ2hhbmdlRG5zUHJvdmlkZXIiLCJjaGVja1N0YXR1c1RvZ2dsZSIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJpbml0aWFsaXplRm9ybSIsIm1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIiLCIkcmVzdWx0QmxvY2siLCJoaWRlIiwiY3VycmVudENoYWxsZW5nZSIsInJlc3RvcmVTYXZlZENyZWRlbnRpYWxzIiwidmFsdWUiLCJzaG93IiwiY3VycmVudFByb3ZpZGVyIiwiJGNvbnRhaW5lciIsImVtcHR5IiwiZG5zUHJvdmlkZXJzTWV0YSIsInByb3ZpZGVyIiwiZmluZCIsInAiLCJpZCIsImZpZWxkcyIsInNhdmVkQ3JlZHMiLCJlbmNvZGVkVmFsIiwidmFsIiwiZGVjb2RlZCIsImF0b2IiLCJKU09OIiwicGFyc2UiLCJlIiwiZm9yRWFjaCIsImZpZWxkIiwic2F2ZWRWYWx1ZSIsImlucHV0VHlwZSIsImh0bWwiLCJsYWJlbCIsImVzY2FwZUh0bWwiLCJhcHBlbmQiLCJjb2xsZWN0RG5zQ3JlZGVudGlhbHMiLCJjaGFsbGVuZ2VUeXBlIiwiY3JlZHMiLCJlYWNoIiwidmFyTmFtZSIsImRhdGEiLCJqc29uIiwic3RyaW5naWZ5IiwiZW5jb2RlZCIsImJ0b2EiLCJ0ZXh0IiwibWFwIiwiU3RyaW5nIiwicmVwbGFjZSIsIm0iLCJnZXRTc2wiLCJhcGkiLCJ1cmwiLCJDb25maWciLCJwYnhVcmwiLCJvbiIsIm1ldGhvZCIsImJlZm9yZVhIUiIsInhociIsInNldFJlcXVlc3RIZWFkZXIiLCJjaGFubmVsSWQiLCJiZWZvcmVTZW5kIiwic2V0dGluZ3MiLCJhZGRDbGFzcyIsImVkaXRvciIsImdldFNlc3Npb24iLCJzZXRWYWx1ZSIsInN1Y2Nlc3NUZXN0IiwiUGJ4QXBpIiwib25TdWNjZXNzIiwicmVzcG9uc2UiLCJyZW1vdmVDbGFzcyIsIm9uRmFpbHVyZSIsIlVzZXJNZXNzYWdlIiwic2hvd011bHRpU3RyaW5nIiwibWVzc2FnZSIsImNiQmVmb3JlU2VuZEZvcm0iLCJyZXN1bHQiLCJmb3JtIiwiY2JBZnRlclNlbmRGb3JtIiwiRm9ybSIsImNoZWNrU3VjY2VzcyIsImdsb2JhbFJvb3RVcmwiLCJlbmFibGVEaXJyaXR5IiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUVBO0FBQ0EsSUFBTUEsS0FBSyxHQUFPLGdCQUFsQixDLENBQWlEOztBQUNqRCxJQUFNQyxNQUFNLEdBQU0scUJBQWxCLEMsQ0FBaUQ7O0FBQ2pELElBQU1DLFNBQVMsR0FBRyxjQUFsQixDLENBQWlEO0FBRWpEOztBQUNBLElBQU1DLFlBQVksR0FBRztBQUNwQjtBQUNBQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyxNQUFNSixNQUFQLENBRlM7QUFHcEJLLEVBQUFBLFdBQVcsRUFBRUQsQ0FBQyxDQUFDLE1BQU1KLE1BQU4sR0FBZSxlQUFoQixD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dGUsIEZvcm0sIENvbmZpZywgUGJ4QXBpLCBkbnNQcm92aWRlcnNNZXRhICovXG5cbi8vIENvbnN0YW50cyByZWxhdGVkIHRvIHRoZSBmb3JtIGFuZCBtb2R1bGVcbmNvbnN0IGlkVXJsICAgICA9ICdtb2R1bGUtZ2V0LXNzbCc7ICAgICAgICAgICAgICAvLyBBUEkgZW5kcG9pbnQgZm9yIFNTTCBtb2R1bGVcbmNvbnN0IGlkRm9ybSAgICA9ICdtb2R1bGUtZ2V0LXNzbC1mb3JtJzsgICAgICAgICAvLyBGb3JtIGVsZW1lbnQgSUQgZm9yIFNTTCBtb2R1bGVcbmNvbnN0IGNsYXNzTmFtZSA9ICdNb2R1bGVHZXRTc2wnOyAgICAgICAgICAgICAgICAvLyBDbGFzcyBuYW1lIGZvciB0aGlzIG1vZHVsZVxuXG4vLyBNYWluIE1vZHVsZUdldFNzbCBjbGFzcyBkZWZpbml0aW9uXG5jb25zdCBNb2R1bGVHZXRTc2wgPSB7XG5cdC8vIENhY2hlIGNvbW1vbmx5IHVzZWQgalF1ZXJ5IG9iamVjdHNcblx0JGZvcm1PYmo6ICQoJyMnICsgaWRGb3JtKSxcblx0JGNoZWNrQm94ZXM6ICQoJyMnICsgaWRGb3JtICsgJyAudWkuY2hlY2tib3gnKSxcblx0JGRpc2FiaWxpdHlGaWVsZHM6ICQoJyMnICsgaWRGb3JtICsgJyAuZGlzYWJpbGl0eScpLFxuXHQkc3RhdHVzVG9nZ2xlOiAkKCcjbW9kdWxlLXN0YXR1cy10b2dnbGUnKSxcblx0JHN1Ym1pdEJ1dHRvbjogJCgnI3N1Ym1pdGJ1dHRvbicpLFxuXHQkbW9kdWxlU3RhdHVzOiAkKCcjc3RhdHVzJyksXG5cdCRjaGFsbGVuZ2VUeXBlOiAkKCcjY2hhbGxlbmdlVHlwZScpLFxuXHQkZG5zUHJvdmlkZXI6ICQoJyNkbnNQcm92aWRlcicpLFxuXHQkaHR0cENoYWxsZW5nZUluZm86ICQoJyNodHRwLWNoYWxsZW5nZS1pbmZvJyksXG5cdCRkbnNTZXR0aW5nc0Jsb2NrOiAkKCcjZG5zLXNldHRpbmdzLWJsb2NrJyksXG5cdCRkbnNDcmVkZW50aWFsc0ZpZWxkczogJCgnI2Rucy1jcmVkZW50aWFscy1maWVsZHMnKSxcblx0JGRuc0NyZWRlbnRpYWxzSW5wdXQ6ICQoJ2lucHV0W25hbWU9XCJkbnNDcmVkZW50aWFsc1wiXScpLFxuXG5cdC8vIFZhbGlkYXRpb24gcnVsZXMgZm9yIHRoZSBmb3JtXG5cdHZhbGlkYXRlUnVsZXM6IHtcblx0XHRkb21haW5OYW1lOiB7XG5cdFx0XHRpZGVudGlmaWVyOiAnZG9tYWluTmFtZScsXG5cdFx0XHRydWxlczogW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0dHlwZTogJ2VtcHR5Jyxcblx0XHRcdFx0XHRwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5tb2R1bGVfZ2V0c3NsX0RvbWFpbk5hbWVFbXB0eSxcblx0XHRcdFx0fSxcblx0XHRcdF0sXG5cdFx0fSxcblx0fSxcblxuXHQvKipcblx0ICogSW5pdGlhbGl6ZSB0aGUgbW9kdWxlLCBiaW5kIGV2ZW50IGxpc3RlbmVycywgYW5kIHNldHVwIHRoZSBmb3JtLlxuXHQgKi9cblx0aW5pdGlhbGl6ZSgpIHtcblx0XHQvLyBJbml0aWFsaXplIFNlbWFudGljIFVJIGNoZWNrYm94ZXNcblx0XHR0aGlzLiRjaGVja0JveGVzLmNoZWNrYm94KCk7XG5cblx0XHQvLyBJbml0aWFsaXplIGRyb3Bkb3duc1xuXHRcdHRoaXMuJGNoYWxsZW5nZVR5cGUuZHJvcGRvd24oe1xuXHRcdFx0b25DaGFuZ2U6IE1vZHVsZUdldFNzbC5vbkNoYW5nZUNoYWxsZW5nZVR5cGUsXG5cdFx0fSk7XG5cdFx0dGhpcy4kZG5zUHJvdmlkZXIuZHJvcGRvd24oe1xuXHRcdFx0ZnVsbFRleHRTZWFyY2g6IHRydWUsXG5cdFx0XHRvbkNoYW5nZTogTW9kdWxlR2V0U3NsLm9uQ2hhbmdlRG5zUHJvdmlkZXIsXG5cdFx0fSk7XG5cblx0XHQvLyBDaGVjayBhbmQgc2V0IG1vZHVsZSBzdGF0dXMgb24gbG9hZCBhbmQgd2hlbiB0aGUgc3RhdHVzIGNoYW5nZXNcblx0XHR0aGlzLmNoZWNrU3RhdHVzVG9nZ2xlKCk7XG5cdFx0d2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ01vZHVsZVN0YXR1c0NoYW5nZWQnLCB0aGlzLmNoZWNrU3RhdHVzVG9nZ2xlKTtcblxuXHRcdC8vIEluaXRpYWxpemUgZm9ybSB3aXRoIHZhbGlkYXRpb24gYW5kIHN1Ym1pdCBoYW5kbGVyc1xuXHRcdHRoaXMuaW5pdGlhbGl6ZUZvcm0oKTtcblxuXHRcdG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLmhpZGUoKTtcblxuXHRcdC8vIFJlc3RvcmUgc2F2ZWQgc3RhdGVcblx0XHRjb25zdCBjdXJyZW50Q2hhbGxlbmdlID0gdGhpcy4kY2hhbGxlbmdlVHlwZS5kcm9wZG93bignZ2V0IHZhbHVlJykgfHwgJ2h0dHAnO1xuXHRcdHRoaXMub25DaGFuZ2VDaGFsbGVuZ2VUeXBlKGN1cnJlbnRDaGFsbGVuZ2UpO1xuXHRcdHRoaXMucmVzdG9yZVNhdmVkQ3JlZGVudGlhbHMoKTtcblx0fSxcblxuXHQvKipcblx0ICogSGFuZGxlIGNoYWxsZW5nZSB0eXBlIGNoYW5nZTogc2hvdy9oaWRlIHJlbGV2YW50IHNlY3Rpb25zLlxuXHQgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSAnaHR0cCcgb3IgJ2Rucydcblx0ICovXG5cdG9uQ2hhbmdlQ2hhbGxlbmdlVHlwZSh2YWx1ZSkge1xuXHRcdGlmICh2YWx1ZSA9PT0gJ2RucycpIHtcblx0XHRcdE1vZHVsZUdldFNzbC4kaHR0cENoYWxsZW5nZUluZm8uaGlkZSgpO1xuXHRcdFx0TW9kdWxlR2V0U3NsLiRkbnNTZXR0aW5nc0Jsb2NrLnNob3coKTtcblx0XHRcdC8vIFRyaWdnZXIgcHJvdmlkZXIgY2hhbmdlIHRvIHJlbmRlciBjcmVkZW50aWFsIGZpZWxkc1xuXHRcdFx0Y29uc3QgY3VycmVudFByb3ZpZGVyID0gTW9kdWxlR2V0U3NsLiRkbnNQcm92aWRlci5kcm9wZG93bignZ2V0IHZhbHVlJyk7XG5cdFx0XHRpZiAoY3VycmVudFByb3ZpZGVyKSB7XG5cdFx0XHRcdE1vZHVsZUdldFNzbC5vbkNoYW5nZURuc1Byb3ZpZGVyKGN1cnJlbnRQcm92aWRlcik7XG5cdFx0XHR9XG5cdFx0fSBlbHNlIHtcblx0XHRcdE1vZHVsZUdldFNzbC4kaHR0cENoYWxsZW5nZUluZm8uc2hvdygpO1xuXHRcdFx0TW9kdWxlR2V0U3NsLiRkbnNTZXR0aW5nc0Jsb2NrLmhpZGUoKTtcblx0XHR9XG5cdH0sXG5cblx0LyoqXG5cdCAqIEhhbmRsZSBETlMgcHJvdmlkZXIgY2hhbmdlOiBkeW5hbWljYWxseSByZW5kZXIgY3JlZGVudGlhbCBmaWVsZHMuXG5cdCAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIHByb3ZpZGVyIElEIChlLmcuICdkbnNfY2YnKVxuXHQgKi9cblx0b25DaGFuZ2VEbnNQcm92aWRlcih2YWx1ZSkge1xuXHRcdGNvbnN0ICRjb250YWluZXIgPSBNb2R1bGVHZXRTc2wuJGRuc0NyZWRlbnRpYWxzRmllbGRzO1xuXHRcdCRjb250YWluZXIuZW1wdHkoKTtcblxuXHRcdGlmICghdmFsdWUgfHwgdHlwZW9mIGRuc1Byb3ZpZGVyc01ldGEgPT09ICd1bmRlZmluZWQnKSB7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXG5cdFx0Ly8gRmluZCBwcm92aWRlciBtZXRhZGF0YVxuXHRcdGNvbnN0IHByb3ZpZGVyID0gZG5zUHJvdmlkZXJzTWV0YS5maW5kKHAgPT4gcC5pZCA9PT0gdmFsdWUpO1xuXHRcdGlmICghcHJvdmlkZXIgfHwgIXByb3ZpZGVyLmZpZWxkcykge1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblxuXHRcdC8vIERlY29kZSBleGlzdGluZyBzYXZlZCBjcmVkZW50aWFscyBmb3IgcHJlLWZpbGxpbmdcblx0XHRsZXQgc2F2ZWRDcmVkcyA9IHt9O1xuXHRcdGNvbnN0IGVuY29kZWRWYWwgPSBNb2R1bGVHZXRTc2wuJGRuc0NyZWRlbnRpYWxzSW5wdXQudmFsKCk7XG5cdFx0aWYgKGVuY29kZWRWYWwpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGNvbnN0IGRlY29kZWQgPSBhdG9iKGVuY29kZWRWYWwpO1xuXHRcdFx0XHRzYXZlZENyZWRzID0gSlNPTi5wYXJzZShkZWNvZGVkKTtcblx0XHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdFx0Ly8gaWdub3JlIGRlY29kZSBlcnJvcnNcblx0XHRcdH1cblx0XHR9XG5cblx0XHQvLyBSZW5kZXIgZmllbGRzXG5cdFx0cHJvdmlkZXIuZmllbGRzLmZvckVhY2goZmllbGQgPT4ge1xuXHRcdFx0Y29uc3Qgc2F2ZWRWYWx1ZSA9IHNhdmVkQ3JlZHNbZmllbGQudmFyXSB8fCAnJztcblx0XHRcdGNvbnN0IGlucHV0VHlwZSA9IGZpZWxkLnR5cGUgPT09ICdwYXNzd29yZCcgPyAncGFzc3dvcmQnIDogJ3RleHQnO1xuXHRcdFx0Y29uc3QgaHRtbCA9IGBcblx0XHRcdFx0PGRpdiBjbGFzcz1cImZpZWxkXCI+XG5cdFx0XHRcdFx0PGxhYmVsPiR7ZmllbGQubGFiZWx9PC9sYWJlbD5cblx0XHRcdFx0XHQ8aW5wdXQgdHlwZT1cIiR7aW5wdXRUeXBlfVwiXG5cdFx0XHRcdFx0XHQgICBjbGFzcz1cImRucy1jcmVkLWlucHV0XCJcblx0XHRcdFx0XHRcdCAgIGRhdGEtdmFyPVwiJHtmaWVsZC52YXJ9XCJcblx0XHRcdFx0XHRcdCAgIHZhbHVlPVwiJHtNb2R1bGVHZXRTc2wuZXNjYXBlSHRtbChzYXZlZFZhbHVlKX1cIlxuXHRcdFx0XHRcdFx0ICAgcGxhY2Vob2xkZXI9XCIke2ZpZWxkLmxhYmVsfVwiPlxuXHRcdFx0XHQ8L2Rpdj5gO1xuXHRcdFx0JGNvbnRhaW5lci5hcHBlbmQoaHRtbCk7XG5cdFx0fSk7XG5cdH0sXG5cblx0LyoqXG5cdCAqIENvbGxlY3QgRE5TIGNyZWRlbnRpYWwgZmllbGQgdmFsdWVzIGludG8gYmFzZTY0IEpTT04gYW5kIHdyaXRlIHRvIGhpZGRlbiBpbnB1dC5cblx0ICovXG5cdGNvbGxlY3REbnNDcmVkZW50aWFscygpIHtcblx0XHRjb25zdCBjaGFsbGVuZ2VUeXBlID0gTW9kdWxlR2V0U3NsLiRjaGFsbGVuZ2VUeXBlLmRyb3Bkb3duKCdnZXQgdmFsdWUnKTtcblx0XHRpZiAoY2hhbGxlbmdlVHlwZSAhPT0gJ2RucycpIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QgY3JlZHMgPSB7fTtcblx0XHQkKCcuZG5zLWNyZWQtaW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRcdGNvbnN0IHZhck5hbWUgPSAkKHRoaXMpLmRhdGEoJ3ZhcicpO1xuXHRcdFx0Y29uc3QgdmFsID0gJCh0aGlzKS52YWwoKTtcblx0XHRcdGlmICh2YXJOYW1lICYmIHZhbCkge1xuXHRcdFx0XHRjcmVkc1t2YXJOYW1lXSA9IHZhbDtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkoY3JlZHMpO1xuXHRcdGNvbnN0IGVuY29kZWQgPSBidG9hKGpzb24pO1xuXHRcdE1vZHVsZUdldFNzbC4kZG5zQ3JlZGVudGlhbHNJbnB1dC52YWwoZW5jb2RlZCk7XG5cdH0sXG5cblx0LyoqXG5cdCAqIFJlc3RvcmUgc2F2ZWQgY3JlZGVudGlhbHMgaW50byB0aGUgRE5TIHByb3ZpZGVyIGZpZWxkcyBvbiBwYWdlIGxvYWQuXG5cdCAqL1xuXHRyZXN0b3JlU2F2ZWRDcmVkZW50aWFscygpIHtcblx0XHRjb25zdCBjdXJyZW50UHJvdmlkZXIgPSBNb2R1bGVHZXRTc2wuJGRuc1Byb3ZpZGVyLmRyb3Bkb3duKCdnZXQgdmFsdWUnKTtcblx0XHRpZiAoY3VycmVudFByb3ZpZGVyKSB7XG5cdFx0XHRNb2R1bGVHZXRTc2wub25DaGFuZ2VEbnNQcm92aWRlcihjdXJyZW50UHJvdmlkZXIpO1xuXHRcdH1cblx0fSxcblxuXHQvKipcblx0ICogRXNjYXBlIEhUTUwgc3BlY2lhbCBjaGFyYWN0ZXJzIGZvciBzYWZlIGluc2VydGlvbiBpbnRvIGF0dHJpYnV0ZXMuXG5cdCAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0XG5cdCAqIEByZXR1cm5zIHtzdHJpbmd9XG5cdCAqL1xuXHRlc2NhcGVIdG1sKHRleHQpIHtcblx0XHRjb25zdCBtYXAgPSB7ICcmJzogJyZhbXA7JywgJzwnOiAnJmx0OycsICc+JzogJyZndDsnLCAnXCInOiAnJnF1b3Q7JywgXCInXCI6ICcmIzAzOTsnIH07XG5cdFx0cmV0dXJuIFN0cmluZyh0ZXh0KS5yZXBsYWNlKC9bJjw+XCInXS9nLCBtID0+IG1hcFttXSk7XG5cdH0sXG5cblx0LyoqXG5cdCAqIFJlcXVlc3QgYW4gU1NMIGNlcnRpZmljYXRlIGJ5IGNhbGxpbmcgdGhlIHNlcnZlci1zaWRlIEFQSS5cblx0ICovXG5cdGdldFNzbCgpIHtcblx0XHQkLmFwaSh7XG5cdFx0XHR1cmw6IGAke0NvbmZpZy5wYnhVcmx9L3BieGNvcmUvYXBpL21vZHVsZXMvJHtjbGFzc05hbWV9L2dldC1jZXJ0YCxcblx0XHRcdG9uOiAnbm93Jyxcblx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0YmVmb3JlWEhSKHhocikge1xuXHRcdFx0XHR4aHIuc2V0UmVxdWVzdEhlYWRlciAoJ1gtQXN5bmMtUmVzcG9uc2UtQ2hhbm5lbC1JZCcsIG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkKTtcblx0XHRcdFx0eGhyLnNldFJlcXVlc3RIZWFkZXIgKCdYLVByb2Nlc3Nvci1UaW1lb3V0JywgJzEyMCcpO1xuXHRcdFx0XHRyZXR1cm4geGhyO1xuXHRcdFx0fSxcblx0XHRcdGJlZm9yZVNlbmQoc2V0dGluZ3MpIHtcblx0XHRcdFx0TW9kdWxlR2V0U3NsLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcgZGlzYWJsZWQnKTtcblx0XHRcdFx0bW9kdWxlR2V0U1NMU3RhdHVzTG9vcFdvcmtlci4kcmVzdWx0QmxvY2suc2hvdygpO1xuXHRcdFx0XHRtb2R1bGVHZXRTU0xTdGF0dXNMb29wV29ya2VyLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUoJycpO1xuXHRcdFx0XHRyZXR1cm4gc2V0dGluZ3M7XG5cdFx0XHR9LFxuXHRcdFx0c3VjY2Vzc1Rlc3Q6IFBieEFwaS5zdWNjZXNzVGVzdCxcblx0XHRcdG9uU3VjY2VzczogZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG5cdFx0XHRcdE1vZHVsZUdldFNzbC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nIGRpc2FibGVkJyk7XG5cdFx0XHR9LFxuXHRcdFx0b25GYWlsdXJlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuXHRcdFx0XHRNb2R1bGVHZXRTc2wuJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZyBkaXNhYmxlZCcpO1xuXHRcdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UubWVzc2FnZSk7XG5cdFx0XHRcdG1vZHVsZUdldFNTTFN0YXR1c0xvb3BXb3JrZXIuJHJlc3VsdEJsb2NrLmhpZGUoKTtcblx0XHRcdH0sXG5cdFx0fSlcblx0fSxcblxuXHQvKipcblx0ICogVG9nZ2xlcyB0aGUgZm9ybSBmaWVsZHMgYW5kIHN0YXR1cyB2aXNpYmlsaXR5IGJhc2VkIG9uIHRoZSBtb2R1bGUncyBzdGF0dXMuXG5cdCAqL1xuXHRjaGVja1N0YXR1c1RvZ2dsZSgpIHtcblx0XHRpZiAoTW9kdWxlR2V0U3NsLiRzdGF0dXNUb2dnbGUuY2hlY2tib3goJ2lzIGNoZWNrZWQnKSkge1xuXHRcdFx0TW9kdWxlR2V0U3NsLiRkaXNhYmlsaXR5RmllbGRzLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdFx0TW9kdWxlR2V0U3NsLiRtb2R1bGVTdGF0dXMuc2hvdygpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRNb2R1bGVHZXRTc2wuJGRpc2FiaWxpdHlGaWVsZHMuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0XHRNb2R1bGVHZXRTc2wuJG1vZHVsZVN0YXR1cy5oaWRlKCk7XG5cdFx0fVxuXHR9LFxuXG5cdC8qKlxuXHQgKiBDYWxsYmFjayBiZWZvcmUgc2VuZGluZyB0aGUgZm9ybS5cblx0ICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gQWpheCByZXF1ZXN0IHNldHRpbmdzLlxuXHQgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgbW9kaWZpZWQgQWpheCByZXF1ZXN0IHNldHRpbmdzLlxuXHQgKi9cblx0Y2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuXHRcdGNvbnN0IHJlc3VsdCA9IHNldHRpbmdzO1xuXHRcdC8vIENvbGxlY3QgRE5TIGNyZWRlbnRpYWxzIGludG8gaGlkZGVuIGZpZWxkIGJlZm9yZSBmb3JtIHN1Ym1pc3Npb25cblx0XHRNb2R1bGVHZXRTc2wuY29sbGVjdERuc0NyZWRlbnRpYWxzKCk7XG5cdFx0cmVzdWx0LmRhdGEgPSBNb2R1bGVHZXRTc2wuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuXHRcdHJldHVybiByZXN1bHQ7XG5cdH0sXG5cblx0LyoqXG5cdCAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHNlbmRpbmcgdGhlIGZvcm0uXG5cdCAqL1xuXHRjYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpIHtcblx0XHRpZiAoRm9ybS5jaGVja1N1Y2Nlc3MocmVzcG9uc2UpKXtcblx0XHRcdE1vZHVsZUdldFNzbC5nZXRTc2woKTtcblx0XHR9XG5cdH0sXG5cblxuXHQvKipcblx0ICogSW5pdGlhbGl6ZXMgdGhlIGZvcm0gdmFsaWRhdGlvbiBhbmQgc3VibWlzc2lvbiBsb2dpYy5cblx0ICovXG5cdGluaXRpYWxpemVGb3JtKCkge1xuXHRcdEZvcm0uJGZvcm1PYmogPSBNb2R1bGVHZXRTc2wuJGZvcm1PYmo7XG5cdFx0Rm9ybS51cmwgPSBgJHtnbG9iYWxSb290VXJsfSR7aWRVcmx9LyR7aWRVcmx9L3NhdmVgO1xuXHRcdEZvcm0udmFsaWRhdGVSdWxlcyA9IE1vZHVsZUdldFNzbC52YWxpZGF0ZVJ1bGVzO1xuXHRcdEZvcm0uZW5hYmxlRGlycml0eSA9IGZhbHNlO1xuXHRcdEZvcm0uY2JBZnRlclNlbmRGb3JtID0gTW9kdWxlR2V0U3NsLmNiQWZ0ZXJTZW5kRm9ybTtcblx0XHRGb3JtLmNiQmVmb3JlU2VuZEZvcm0gPSBNb2R1bGVHZXRTc2wuY2JCZWZvcmVTZW5kRm9ybTtcblx0XHRGb3JtLmluaXRpYWxpemUoKTtcblx0fSxcbn07XG5cbi8vIEluaXRpYWxpemUgdGhlIE1vZHVsZUdldFNzbCBjbGFzcyB3aGVuIHRoZSBkb2N1bWVudCBpcyByZWFkeVxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHRNb2R1bGVHZXRTc2wuaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=